<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√öSZ Cs√≥cs√≥ Bajnoks√°g</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- Firebase SDKs (Version 10.8.0 compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Mountains of Christmas', 'cursive'],
                    },
                    colors: {
                        festiveRed: '#e63946',
                        festiveGold: '#ffd700',
                        festiveGreen: '#2d6a4f',
                        wood: '#8B4513',
                        dark: '#0b0f19',
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0b0f19; color: #f1f5f9; overflow-x: hidden; }
        #canvas-container { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: -1; background: radial-gradient(circle at center, #1a2332 0%, #0b0f19 90%); }
        .glass-panel { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 215, 0, 0.1); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5); }
        .gold-glow { text-shadow: 0 0 10px rgba(255, 215, 0, 0.6); }
        .input-field { background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255, 255, 255, 0.1); color: white; transition: all 0.3s ease; }
        .input-field:focus { outline: none; border-color: #e63946; box-shadow: 0 0 10px rgba(230, 57, 70, 0.3); }
        .raffle-box { background: rgba(0, 0, 0, 0.6); border: 2px solid #ffd700; box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); }
        .slot-machine-text { font-family: 'Mountains of Christmas', cursive; text-shadow: 0 0 15px currentColor; }
        .page-section { transition: opacity 0.3s ease-in-out; }
        .hidden-page { display: none; opacity: 0; }
        @keyframes flashGreen { 0% { background-color: rgba(34, 197, 94, 0.5); } 100% { background-color: rgba(0, 0, 0, 0.4); } }
        .flash-success { animation: flashGreen 1s ease-out; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body class="antialiased selection:bg-festiveRed selection:text-white">

    <div id="canvas-container"></div>

    <nav class="fixed w-full z-50 transition-all duration-300 glass-panel border-b border-white/5">
        <div class="max-w-7xl mx-auto px-6 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2 cursor-pointer" onclick="showPage('home')">
                <span class="text-2xl pt-1">üéÑ</span>
                <span class="text-xl md:text-2xl font-display font-bold tracking-wider text-white">M√öSZ <span class="text-festiveRed">BAJNOKS√ÅG</span></span>
            </div>
            <div class="hidden md:flex space-x-6 text-sm font-semibold tracking-wide items-center">
                <button onclick="showPage('home')" class="hover:text-festiveGold transition-colors">KEZD≈êLAP</button>
                <button onclick="showPage('raffle')" class="text-festiveRed hover:text-white transition-colors font-bold">SORSOL√ÅS</button>
                <button onclick="scrollToSection('matches')" class="hover:text-festiveGold transition-colors">MECCSEK</button>
                <button onclick="scrollToSection('standings')" class="hover:text-festiveGold transition-colors">TABELLA</button>
            </div>
            <button onclick="scrollToSection('register')" class="bg-festiveRed text-white px-4 py-2 text-sm md:text-base rounded-full font-bold hover:bg-red-700 transition-colors shadow-lg">
                NEVEZ√âS
            </button>
        </div>
    </nav>

    <main class="relative z-10 pt-24 pb-20 space-y-32">

        <!-- ================= HOME PAGE ================= -->
        <div id="page-home" class="page-section space-y-32">
            <section id="welcome" class="min-h-[80vh] flex items-center justify-center px-6">
                <div class="text-center max-w-4xl mx-auto space-y-6">
                    <span class="inline-block py-1 px-4 rounded-full border border-festiveGold/30 bg-festiveGold/10 text-festiveGold text-sm font-bold tracking-widest uppercase mb-4">‚ùÑÔ∏è T√©li Szezon 2025</span>
                    <h1 class="text-5xl md:text-8xl font-display font-bold leading-tight text-white drop-shadow-lg">KAR√ÅCSONYI <br/><span class="text-festiveRed gold-glow">CS√ìCS√ì KUPA</span></h1>
                    <p class="text-lg text-gray-300 max-w-xl mx-auto leading-relaxed">A hivatalos M√öSZ cs√≥cs√≥ bajnoks√°g visszat√©rt! Regisztr√°ljatok, p√∂rgess√©tek fel az √ºnnepi hangulatot!</p>
                    <div class="flex flex-col sm:flex-row gap-4 justify-center pt-8">
                        <button onclick="document.getElementById('register').scrollIntoView({behavior: 'smooth'})" class="group relative px-8 py-4 bg-festiveRed text-white font-bold text-lg rounded-lg overflow-hidden shadow-lg transition-transform hover:scale-105">
                            <span class="relative z-10">NEVEZ√âS IND√çT√ÅSA</span>
                        </button>
                    </div>
                </div>
            </section>

            <section id="register" class="max-w-3xl mx-auto px-6">
                <div class="glass-panel rounded-2xl p-8 md:p-12 relative overflow-hidden border-t-4 border-festiveRed">
                    <div class="absolute -top-10 -right-10 text-9xl opacity-10 rotate-12">üéÖ</div>
                    <h2 class="text-4xl font-display font-bold mb-8 text-center text-festiveGold">NEVEZ√âS</h2>
                    <div class="flex justify-center mb-8 border-b border-white/10">
                        <button id="tab-solo" class="pb-3 px-6 text-festiveRed border-b-2 border-festiveRed font-bold transition-all" onclick="switchTab('solo')">Egy√©ni</button>
                        <button id="tab-team" class="pb-3 px-6 text-gray-400 hover:text-white transition-all" onclick="switchTab('team')">Csapat</button>
                    </div>
                    <div id="form-alert" class="hidden mb-4 p-4 rounded bg-green-500/20 border border-green-500 text-green-200 text-sm text-center"></div>

                    <form id="form-solo" class="space-y-5">
                        <input type="text" id="solo-name" required class="input-field w-full p-3 rounded" placeholder="Teljes N√©v">
                        <input type="text" id="solo-dept" required class="input-field w-full p-3 rounded" placeholder="R√©szleg">
                        <button type="submit" class="w-full bg-festiveGold hover:bg-yellow-400 text-black font-bold py-4 rounded transition-all mt-4 uppercase tracking-widest shadow-lg">Egy√©ni Jelentkez√©s</button>
                    </form>

                    <form id="form-team" class="space-y-5 hidden">
                        <input type="text" id="team-name" required class="input-field w-full p-3 rounded" placeholder="Csapatn√©v">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="p1-name" required class="input-field w-full p-3 rounded" placeholder="1. J√°t√©kos">
                            <input type="text" id="p2-name" required class="input-field w-full p-3 rounded" placeholder="2. J√°t√©kos">
                        </div>
                        <button type="submit" class="w-full bg-festiveGold hover:bg-yellow-400 text-black font-bold py-4 rounded transition-all mt-4 uppercase tracking-widest shadow-lg">Csapat Regisztr√°ci√≥</button>
                    </form>
                </div>
            </section>

            <section id="matches" class="max-w-6xl mx-auto px-6">
                <div class="flex items-center justify-between mb-10">
                    <h2 class="text-3xl md:text-4xl font-display font-bold text-festiveRed">K√ñVETKEZ≈ê MECCSEK</h2>
                    <span class="text-festiveGold text-xs md:text-sm animate-pulse flex items-center gap-2">
                        <span class="w-2 h-2 bg-festiveGold rounded-full"></span> √âL≈ê
                    </span>
                </div>
                <div id="matches-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </section>

            <section id="standings" class="max-w-5xl mx-auto px-6">
                <h2 class="text-4xl font-display font-bold mb-8 text-center text-white">RANGILISTA</h2>
                <div class="glass-panel rounded-xl overflow-hidden shadow-[0_0_20px_rgba(230,57,70,0.2)] overflow-x-auto">
                    <table class="w-full text-left border-collapse min-w-[600px]">
                        <thead>
                            <tr class="bg-festiveRed/20 text-gray-300 text-xs uppercase tracking-wider">
                                <th class="p-4 font-medium">Helyez√©s</th>
                                <th class="p-4 font-medium">Csapat</th>
                                <th class="p-4 font-medium text-center">Meccs</th>
                                <th class="p-4 font-medium text-center">Gy-V</th>
                                <th class="p-4 font-medium text-right text-festiveGold">Pont</th>
                            </tr>
                        </thead>
                        <tbody id="standings-body" class="divide-y divide-white/5 text-sm"></tbody>
                    </table>
                </div>
            </section>

            <section id="rules" class="max-w-4xl mx-auto px-6">
                 <h2 class="text-4xl font-display font-bold mb-10 text-center text-white">J√ÅT√âKSZAB√ÅLYOK</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                     <div class="glass-panel p-6 rounded-lg border-l-4 border-festiveRed"><h3 class="text-xl font-bold mb-3 text-festiveGold">01. P√∂rget√©s</h3><p id="rule-0" class="text-gray-400">...</p></div>
                     <div class="glass-panel p-6 rounded-lg border-l-4 border-festiveRed"><h3 class="text-xl font-bold mb-3 text-festiveGold">02. Pontoz√°s</h3><p id="rule-1" class="text-gray-400">...</p></div>
                     <div class="glass-panel p-6 rounded-lg border-l-4 border-festiveRed"><h3 class="text-xl font-bold mb-3 text-festiveGold">03. Holt labda</h3><p id="rule-2" class="text-gray-400">...</p></div>
                     <div class="glass-panel p-6 rounded-lg border-l-4 border-festiveRed"><h3 class="text-xl font-bold mb-3 text-festiveGold">04. Fair Play</h3><p id="rule-3" class="text-gray-400">...</p></div>
                 </div>
            </section>
        </div>

        <!-- ================= RAFFLE PAGE ================= -->
        <div id="page-raffle" class="page-section hidden-page">
            <section class="max-w-6xl mx-auto px-6 relative pt-10">
                <button onclick="showPage('home')" class="mb-8 text-gray-400 hover:text-white flex items-center gap-2"><span>‚Üê</span> Vissza a f≈ëoldalra</button>
                <h2 class="text-4xl font-display font-bold mb-8 text-center text-festiveGold drop-shadow-[0_0_10px_rgba(255,215,0,0.5)]">SORSOL√ÅS AR√âNA</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="glass-panel p-6 rounded-xl order-2 lg:order-1">
                        <h3 class="text-xl font-bold mb-4 text-white">Sorsol√°si Kalap</h3>
                        <p class="text-xs text-gray-400 mb-2">Regisztr√°lt csapatok:</p>
                        <textarea id="raffle-pool" class="w-full h-48 bg-black/40 border border-white/20 rounded-lg p-3 text-sm text-gray-300 focus:border-festiveGold outline-none"></textarea>
                        <div class="flex gap-2 mt-4">
                            <button onclick="loadRegisteredTeams()" class="text-xs text-festiveGold underline hover:text-white font-bold">Friss√≠t√©s</button>
                            <div class="flex-1"></div>
                            <span id="pool-count" class="text-sm text-festiveGold font-bold self-center">0 csapat</span>
                        </div>
                    </div>
                    <div class="col-span-1 lg:col-span-2 order-1 lg:order-2 flex flex-col items-center">
                        <div class="w-full bg-black/60 border-4 border-festiveRed rounded-2xl p-8 mb-8 relative overflow-hidden shadow-[0_0_50px_rgba(230,57,70,0.3)] min-h-[300px] flex flex-col justify-center items-center">
                            <div id="raffle-display" class="w-full flex flex-col md:flex-row items-center justify-center gap-4 md:gap-8 opacity-50 transition-all duration-500">
                                <div class="raffle-box w-full md:w-1/2 h-32 flex items-center justify-center rounded-lg relative overflow-hidden"><span id="slot-1" class="slot-machine-text text-3xl md:text-4xl text-white text-center px-2">?</span></div>
                                <div class="text-4xl font-black text-festiveRed italic drop-shadow-[0_0_10px_rgba(230,57,70,0.8)]">VS</div>
                                <div class="raffle-box w-full md:w-1/2 h-32 flex items-center justify-center rounded-lg relative overflow-hidden"><span id="slot-2" class="slot-machine-text text-3xl md:text-4xl text-white text-center px-2">?</span></div>
                            </div>
                            <div id="match-announcement" class="absolute inset-0 flex items-center justify-center bg-black/80 backdrop-blur-sm z-10 hidden transform scale-0 transition-transform duration-500">
                                 <div class="text-center"><h3 class="text-festiveGold text-sm uppercase tracking-widest mb-2">√öj P√°ros√≠t√°s</h3><div id="announced-match" class="text-3xl md:text-5xl font-display font-bold text-white leading-tight"></div></div>
                            </div>
                        </div>
                        <button id="draw-btn" onclick="startDraw()" class="w-full max-w-md py-4 bg-gradient-to-r from-festiveRed to-red-700 text-white font-bold text-xl rounded-full shadow-[0_0_20px_rgba(230,57,70,0.6)] hover:scale-105 transition-transform uppercase tracking-widest border border-white/20">K√ñVETKEZ≈ê P√ÅROS√çT√ÅS</button>
                    </div>
                </div>
            </section>
        </div>

        <!-- ================= DIAGNOSTICS MODAL ================= -->
        <div id="diag-modal" class="fixed inset-0 z-[70] bg-black/90 hidden flex items-center justify-center p-4">
            <div class="bg-gray-900 border-2 border-blue-500 p-6 rounded-xl max-w-lg w-full shadow-2xl relative">
                <button onclick="document.getElementById('diag-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-white">‚úï</button>
                <h3 class="text-xl font-mono font-bold text-blue-400 mb-4">üîß Rendszer Diagnosztika</h3>
                <div id="diag-content" class="font-mono text-xs text-gray-300 space-y-2 whitespace-pre-wrap h-64 overflow-y-auto bg-black/50 p-4 rounded border border-gray-800">
                    Tesztel√©s folyamatban...
                </div>
                <div class="mt-4 text-center">
                    <button onclick="document.getElementById('diag-modal').classList.add('hidden')" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded font-bold text-sm">Bez√°r√°s</button>
                </div>
            </div>
        </div>

        <!-- ================= ADMIN PANEL ================= -->
        <div id="admin-login-modal" class="fixed inset-0 z-[60] bg-black/80 hidden flex items-center justify-center p-4">
            <div class="bg-gray-900 border border-festiveRed p-8 rounded-xl max-w-sm w-full shadow-2xl">
                <h3 class="text-xl font-bold text-white mb-4 text-center">Admin Bel√©p√©s</h3>
                <input type="password" id="admin-password" placeholder="Jelsz√≥" class="w-full p-3 bg-gray-800 text-white rounded mb-4 border border-gray-700 focus:border-festiveRed outline-none">
                <div class="flex gap-2">
                    <button onclick="checkAdminPassword()" class="flex-1 bg-festiveRed hover:bg-red-700 text-white py-2 rounded font-bold transition">Bel√©p√©s</button>
                    <button onclick="closeAdminModal()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white py-2 rounded font-bold transition">M√©gse</button>
                </div>
            </div>
        </div>

        <section id="admin-panel" class="hidden max-w-5xl mx-auto px-6 pb-20 mt-20 border-t border-white/10 pt-10">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-display font-bold text-red-500">ADMINISZTR√ÅCI√ì</h2>
                <button onclick="closeAdminPanel()" class="text-gray-400 hover:text-white underline text-sm">Kil√©p√©s</button>
            </div>
            
            <div class="grid gap-8">
                <!-- Registration List -->
                <div class="glass-panel p-6 rounded-lg">
                    <h3 class="text-lg font-bold mb-4 text-festiveGold">Regisztr√°ci√≥k <span id="data-source-indicator" class="text-xs ml-2 text-gray-500"></span></h3>
                    <div id="admin-registrations-list" class="space-y-2 max-h-60 overflow-y-auto bg-black/20 p-4 rounded text-sm text-gray-300">
                        <p class="italic">Bet√∂lt√©s...</p>
                    </div>
                </div>

                <!-- Rules Editor -->
                <div class="glass-panel p-6 rounded-lg">
                    <h3 class="text-lg font-bold mb-4 text-festiveGold">Szab√°lyok</h3>
                    <div class="space-y-4">
                        <textarea id="admin-rule-0" class="w-full bg-black/40 border border-white/10 rounded p-2 text-gray-300 text-sm" rows="2"></textarea>
                        <textarea id="admin-rule-1" class="w-full bg-black/40 border border-white/10 rounded p-2 text-gray-300 text-sm" rows="2"></textarea>
                        <textarea id="admin-rule-2" class="w-full bg-black/40 border border-white/10 rounded p-2 text-gray-300 text-sm" rows="2"></textarea>
                        <textarea id="admin-rule-3" class="w-full bg-black/40 border border-white/10 rounded p-2 text-gray-300 text-sm" rows="2"></textarea>
                        <button onclick="saveRules()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-sm font-bold">Szab√°lyok Ment√©se</button>
                    </div>
                </div>

                <!-- Match Editor -->
                <div class="glass-panel p-6 rounded-lg">
                    <h3 class="text-lg font-bold mb-4 text-festiveGold">Meccsek Kezel√©se</h3>
                    <button onclick="addNewMatch()" class="mb-4 bg-festiveGold text-black px-4 py-2 rounded text-sm font-bold">+ √öj Meccs</button>
                    <div id="admin-matches-list" class="space-y-4"></div>
                </div>
            </div>
        </section>

        <footer class="border-t border-white/10 py-12 text-center text-gray-500 text-sm mt-20">
            <p>&copy; 2025 M√öSZ Cs√≥cs√≥ Bajnoks√°g.</p>
            <div id="db-status" class="text-xs font-mono mt-2 text-gray-600">‚ö™ Kapcsol√≥d√°s...</div>
            <div class="flex justify-center gap-4 mt-4">
                <button onclick="runDiagnostics()" class="text-blue-400 hover:text-blue-300 text-xs uppercase tracking-widest cursor-pointer">üîß Rendszer Teszt</button>
                <button onclick="openAdminModal()" class="text-gray-700 hover:text-gray-500 text-xs uppercase tracking-widest cursor-pointer">Admin Bel√©p√©s</button>
            </div>
        </footer>

    </main>

    <!-- MOVED SCRIPT TO BOTTOM TO FIX LOADING ISSUES -->
    <script>
        // --- 1. CONFIGURATION (SANITIZED) ---
        const firebaseConfig = {
            apiKey: "AIzaSyD0Ptqxehpi3_LzGPcTNMwGnAGgqyU5cro",
            authDomain: "karacsonyi-csocso.firebaseapp.com",
            projectId: "karacsonyi-csocso",
            storageBucket: "karacsonyi-csocso.firebasestorage.app",
            messagingSenderId: "541085489834",
            appId: "1:541085489834:web:790c95e5dff50ffd80ced3"
        };

        // --- GLOBAL STATE ---
        let matchesData = [];
        let rulesData = ["Szab√°ly 1...", "Szab√°ly 2...", "Szab√°ly 3...", "Szab√°ly 4..."];
        let registrations = [];
        let db = null;
        let isOnline = false;
        let isUsingLocalStorage = false;

        // --- ERROR HANDLER ---
        window.onerror = function(msg, url, line, col, error) {
            console.error("Global Error:", msg);
            return false;
        };

        // --- MAIN INITIALIZATION (Wait for DOM) ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Start 3D
            if(typeof THREE !== 'undefined') {
                init3D(); 
            } else {
                console.error("Three.js missing!");
            }

            // 2. Initialize Firebase
            if (typeof firebase !== 'undefined' && firebaseConfig.apiKey) {
                try {
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    
                    // FIX FOR CORPORATE FIREWALLS - STRICT FORCE MODE WITHOUT PERSISTENCE
                    try {
                        db.settings({ 
                            experimentalForceLongPolling: true,
                            useFetchStreams: false 
                        });
                    } catch(err) { console.log("Settings warning:", err); }
                    
                    const auth = firebase.auth();
                    auth.signInAnonymously().then(() => {
                        console.log("Connected to Database");
                        isOnline = true;
                        const statusEl = document.getElementById('db-status');
                        if(statusEl) {
                            statusEl.innerHTML = 'üü¢ Adatb√°zis: Kapcsol√≥dva';
                            statusEl.className = 'text-xs font-mono mt-2 text-green-500';
                        }
                        startListeners();
                    }).catch(e => {
                        console.error("Auth failed", e);
                        const statusEl = document.getElementById('db-status');
                        if(statusEl) {
                            statusEl.innerHTML = 'üî¥ Adatb√°zis: Hiba (Auth - Enged√©lyezd az Anonymoust!)';
                            statusEl.className = 'text-xs font-mono mt-2 text-red-500';
                        }
                    });
                } catch(e) { console.error("Firebase init failed", e); alert("Firebase Init Hiba: " + e.message); }
            } else {
                console.warn("No Firebase Config or SDK! Using LocalStorage only.");
                useLocalStorageFallback();
            }
        });

        function useLocalStorageFallback() {
            isUsingLocalStorage = true;
            // Load LocalStorage fallback
            const savedM = localStorage.getItem('musz_matches');
            if (savedM) matchesData = JSON.parse(savedM);
            const savedR = localStorage.getItem('musz_rules');
            if (savedR) rulesData = JSON.parse(savedR);
            const savedReg = localStorage.getItem('musz_registrations');
            if (savedReg) registrations = JSON.parse(savedReg);
            
            renderAll();
        }

        // --- REALTIME LISTENERS ---
        function startListeners() {
            // Matches
            db.collection('matches').orderBy('timestamp', 'asc').onSnapshot(snapshot => {
                matchesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            }, (error) => {
                console.warn("Snapshot Listener Error (Matches):", error);
                const statusEl = document.getElementById('db-status');
                if(statusEl) {
                    statusEl.innerHTML = 'üî¥ Hiba: ' + error.code;
                    statusEl.className = 'text-xs font-mono mt-2 text-red-500';
                }
            });

            // Registrations
            db.collection('registrations').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
                registrations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAdminRegistrations();
                loadRegisteredTeams(); // Update raffle pool automatically
            }, (error) => {
                console.warn("Snapshot Listener Error (Regs):", error);
            });

            // Rules
            db.collection('settings').doc('rules').onSnapshot(doc => {
                if (doc.exists) {
                    rulesData = doc.data().list;
                    renderAll();
                } else {
                    // Seed initial rules if missing
                    db.collection('settings').doc('rules').set({ list: rulesData });
                }
            }, (error) => {
                console.warn("Snapshot Listener Error (Rules):", error);
            });
        }

        // --- DIAGNOSTICS ---
        async function runDiagnostics() {
            document.getElementById('diag-modal').classList.remove('hidden');
            const output = document.getElementById('diag-content');
            
            if (!db) { 
                output.innerText = "HIBA: Firebase nincs inicializ√°lva.\n(Ellen≈ërizd az API kulcsokat a k√≥dban)"; 
                return; 
            }
            
            let report = "--- RENDSZER DIAGNOSZTIKA ---\n\n";
            output.innerText = report + "Tesztel√©s...";
            
            // 1. Auth Check
            const user = firebase.auth().currentUser;
            report += `1. AUTHENTIK√ÅCI√ì:\n   > ${user ? 'SIKERES ‚úÖ (UID: ' + user.uid.substring(0,5) + '...)' : 'SIKERTELEN ‚ùå (Nincs bel√©pve)'}\n`;
            if(!user) report += "   > Tipp: Enged√©lyezd az 'Anonymous' bel√©p√©st a Firebase konzolon.\n";
            report += "\n";
            output.innerText = report + "Adatb√°zis √≠r√°s tesztel√©se...";

            // 2. Write Check
            try {
                // Timeout check for write
                const writePromise = db.collection('_diagnostics').add({ timestamp: Date.now(), user: user ? user.uid : 'anon', check: 'system_test' });
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error("Id≈ët√∫ll√©p√©s (5s) - T≈±zfal blokkolja?")), 5000)
                );
                
                await Promise.race([writePromise, timeoutPromise]);
                
                report += "2. ADATB√ÅZIS √çR√ÅS:\n   > SIKERES ‚úÖ (Kapcsolat stabil)\n";
            } catch (err) {
                report += `2. ADATB√ÅZIS √çR√ÅS:\n   > SIKERTELEN ‚ùå\n   > √úzenet: ${err.message}\n`;
                if(err.code === 'permission-denied') {
                    report += "\n   >>> MEGOLD√ÅS: <<<\n   A Firestore Rules blokkolja az √≠r√°st.\n   Menj a Firebase Console -> Build -> Firestore Database -> Rules f√ºlre.\n   √çrd √°t erre: allow read, write: if true;\n";
                }
            }

            output.innerText = report;
        }

        // --- RENDER FUNCTIONS ---
        function renderAll() {
            renderMatches();
            renderStandings(); 
            renderRules();
            if(!document.getElementById('admin-panel').classList.contains('hidden')) {
                renderAdminMatches();
                renderAdminRegistrations();
                renderAdminRules();
            }
        }

        function renderMatches() {
            const container = document.getElementById('matches-container');
            if(!container) return;
            container.innerHTML = matchesData.length ? matchesData.map(m => `
                <div class="glass-panel p-6 rounded-xl border-b-4 ${m.s1 > 0 || m.s2 > 0 ? 'border-green-500' : 'border-gray-700'} flex flex-col justify-between h-full">
                    <div class="flex justify-between items-start mb-6 border-b border-white/10 pb-3">
                        <span class="text-xs font-bold text-festiveGold uppercase tracking-widest">${m.status || 'Tervezett'}</span>
                        <span class="text-xs text-gray-400 font-mono">${m.time || ''}</span>
                    </div>
                    <div class="flex items-center justify-between gap-2">
                        <div class="flex-1 text-left"><div class="font-bold text-white text-lg leading-tight break-words">${m.t1}</div></div>
                        <div class="px-4 py-2 bg-black/40 rounded-lg border border-white/10 min-w-[80px] text-center shrink-0">
                            <span class="font-display font-bold text-3xl text-white tracking-widest">${m.s1}-${m.s2}</span>
                        </div>
                        <div class="flex-1 text-right"><div class="font-bold text-white text-lg leading-tight break-words">${m.t2}</div></div>
                    </div>
                </div>
            `).join('') : '<p class="text-gray-400 col-span-full text-center">Nincsenek akt√≠v meccsek.</p>';
        }

        // --- FIX: ADDED MISSING RENDER STANDINGS FUNCTION ---
        function renderStandings() {
            const body = document.getElementById('standings-body');
            if(!body) return;
            body.innerHTML = '';

            const stats = {};
            
            // Seg√©df√ºggv√©ny csapat inicializ√°l√°shoz
            const initTeam = (name) => {
                if (!stats[name]) stats[name] = { name, played: 0, w: 0, l: 0, pts: 0 };
            };

            matchesData.forEach(m => {
                if(m.t1 && m.t2) {
                    initTeam(m.t1);
                    initTeam(m.t2);
                    
                    // Csak ha volt eredm√©ny
                    if (m.s1 > 0 || m.s2 > 0) { 
                        stats[m.t1].played++;
                        stats[m.t2].played++;
                        
                        if (m.s1 > m.s2) {
                            stats[m.t1].w++;
                            stats[m.t1].pts += 3;
                            stats[m.t2].l++;
                        } else if (m.s2 > m.s1) {
                            stats[m.t2].w++;
                            stats[m.t2].pts += 3;
                            stats[m.t1].l++;
                        } else {
                            // D√∂ntetlen (opcion√°lis, ha van ilyen szab√°ly)
                            stats[m.t1].pts += 1;
                            stats[m.t2].pts += 1;
                        }
                    }
                }
            });

            // Rendez√©s: Pontsz√°m (cs√∂kken≈ë), majd Gy≈ëzelmek (cs√∂kken≈ë)
            const sortedTeams = Object.values(stats).sort((a,b) => b.pts - a.pts || b.w - a.w);

            if (sortedTeams.length === 0) {
                body.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500 italic">M√©g nincs lej√°tszott meccs.</td></tr>';
                return;
            }

            body.innerHTML = sortedTeams.map((t, i) => `
                <tr class="hover:bg-white/5 transition-colors">
                    <td class="p-4 font-bold ${i === 0 ? 'text-festiveGold' : 'text-gray-400'}">
                        ${i === 0 ? 'üëë ' : ''}#${i+1}
                    </td>
                    <td class="p-4 font-medium text-white">${t.name}</td>
                    <td class="p-4 text-center text-gray-400">${t.played}</td>
                    <td class="p-4 text-center text-gray-400">${t.w}-${t.l}</td>
                    <td class="p-4 text-right font-bold text-festiveRed">${t.pts}</td>
                </tr>
            `).join('');
        }

        function renderRules() {
            rulesData.forEach((r, i) => { 
                const el = document.getElementById(`rule-${i}`);
                if(el) el.innerText = r;
            });
        }

        function renderAdminRegistrations() {
            const list = document.getElementById('admin-registrations-list');
            const indicator = document.getElementById('data-source-indicator');
            
            if (isUsingLocalStorage) {
                indicator.innerText = "(üíª Helyi ment√©s - Nem szinkroniz√°l)";
                indicator.className = "text-xs ml-2 text-yellow-500 font-bold";
            } else {
                indicator.innerText = "(‚òÅÔ∏è Felh≈ë - √âL≈ê)";
                indicator.className = "text-xs ml-2 text-green-500 font-bold";
            }

            if(!list) return;
            if (registrations.length === 0) list.innerHTML = '<p class="italic">Nincs adat.</p>';
            else {
                list.innerHTML = registrations.map(r => `
                    <div class="border-b border-white/10 py-2">
                        <span class="text-festiveGold font-bold uppercase text-xs">[${r.type === 'team' ? 'CSAPAT' : 'EGY√âNI'}]</span>
                        <span class="text-white ml-2">${r.type === 'team' ? r.teamName : r.name}</span>
                    </div>
                `).join('');
            }
        }

        function renderAdminMatches() {
            const list = document.getElementById('admin-matches-list');
            if(!list) return;
            list.innerHTML = matchesData.map(m => `
                <div id="admin-row-${m.id}" class="flex flex-col md:flex-row items-center gap-4 bg-black/40 p-4 rounded border border-white/10">
                    <div class="w-full md:w-1/3"><input type="text" value="${m.t1}" id="team1-${m.id}" class="w-full bg-transparent text-festiveGold font-bold text-center md:text-left border-b border-white/10 outline-none"></div>
                    <div class="flex items-center gap-3 justify-center">
                        <input type="number" value="${m.s1}" id="score1-${m.id}" class="w-16 p-2 bg-gray-800 rounded text-center text-white font-bold text-xl">
                        <span class="text-gray-500">-</span>
                        <input type="number" value="${m.s2}" id="score2-${m.id}" class="w-16 p-2 bg-gray-800 rounded text-center text-white font-bold text-xl">
                    </div>
                    <div class="w-full md:w-1/3"><input type="text" value="${m.t2}" id="team2-${m.id}" class="w-full bg-transparent text-gray-300 font-bold text-center md:text-right border-b border-white/10 outline-none"></div>
                    <button onclick="saveMatch('${m.id}')" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded font-bold text-sm">OK</button>
                    <button onclick="deleteMatch('${m.id}')" class="text-red-500 hover:text-white px-2">X</button>
                </div>
            `).join('');
        }

        function renderAdminRules() {
             rulesData.forEach((r, i) => {
                 const el = document.getElementById(`admin-rule-${i}`);
                 if(el) el.value = r;
             });
        }

        // --- ACTIONS (DB WRITES) ---

        async function saveMatch(id) {
            const t1 = document.getElementById(`team1-${id}`).value;
            const t2 = document.getElementById(`team2-${id}`).value;
            const s1 = parseInt(document.getElementById(`score1-${id}`).value) || 0;
            const s2 = parseInt(document.getElementById(`score2-${id}`).value) || 0;
            
            const updateData = { t1, t2, s1, s2, status: (s1 > 0 || s2 > 0) ? 'V√©get √©rt' : 'Hamarosan' };

            if(isOnline && !isUsingLocalStorage) {
                await db.collection('matches').doc(id).update(updateData);
            } else {
                const idx = matchesData.findIndex(m => m.id === id);
                if(idx !== -1) matchesData[idx] = { ...matchesData[idx], ...updateData };
                localStorage.setItem('musz_matches', JSON.stringify(matchesData));
                renderAll();
            }
        }

        async function addNewMatch() {
            const newMatch = { t1: "Csapat A", t2: "Csapat B", s1: 0, s2: 0, status: "Tervezett", timestamp: Date.now() };
            if (isOnline && !isUsingLocalStorage) {
                await db.collection('matches').add(newMatch);
            } else {
                newMatch.id = Date.now().toString();
                matchesData.push(newMatch);
                localStorage.setItem('musz_matches', JSON.stringify(matchesData));
                renderAll();
            }
        }

        async function deleteMatch(id) {
             if(!confirm("Biztosan t√∂rl√∂d?")) return;
             if(isOnline && !isUsingLocalStorage) await db.collection('matches').doc(id).delete();
             else {
                 matchesData = matchesData.filter(m => m.id !== id);
                 localStorage.setItem('musz_matches', JSON.stringify(matchesData));
                 renderAll();
             }
        }

        async function saveRules() {
            const newRules = [
                document.getElementById('admin-rule-0').value,
                document.getElementById('admin-rule-1').value,
                document.getElementById('admin-rule-2').value,
                document.getElementById('admin-rule-3').value
            ];
            if(isOnline && !isUsingLocalStorage) {
                await db.collection('settings').doc('rules').set({ list: newRules });
            } else {
                rulesData = newRules;
                localStorage.setItem('musz_rules', JSON.stringify(rulesData));
            }
            alert("Szab√°lyok mentve!");
        }

        // UPDATED REGISTRATION HANDLER
        async function handleRegistration(e, type) {
            e.preventDefault();
            const alertBox = document.getElementById('form-alert');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerText;

            // UI Feedback: Loading
            submitBtn.disabled = true;
            submitBtn.innerText = "Ment√©s folyamatban...";
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
            
            let data = { type, timestamp: Date.now() };
            
            if (type === 'individual') {
                data.name = document.getElementById('solo-name').value;
                data.dept = document.getElementById('solo-dept').value;
            } else {
                data.teamName = document.getElementById('team-name').value;
                data.p1 = document.getElementById('p1-name').value;
                data.p2 = document.getElementById('p2-name').value;
            }

            try {
                if(isOnline && !isUsingLocalStorage) {
                    // Create a promise that rejects after 15 seconds (Extended)
                    const savePromise = db.collection('registrations').add(data);
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error("Timeout (15s)")), 15000)
                    );
                    
                    await Promise.race([savePromise, timeoutPromise]);
                } else {
                    throw new Error("Offline m√≥d."); 
                }

                // Success
                alertBox.textContent = "Sikeres regisztr√°ci√≥!";
                alertBox.className = "mb-4 p-4 rounded bg-green-500/20 border border-green-500 text-green-200 text-center block";
                alertBox.classList.remove('hidden');
                e.target.reset();
                setTimeout(() => alertBox.classList.add('hidden'), 3000);

            } catch (err) {
                console.error("Registration error:", err);
                
                // Fallback to LocalStorage if server fails
                registrations.push(data);
                localStorage.setItem('musz_registrations', JSON.stringify(registrations));
                
                // Force local usage flag
                useLocalStorageFallback(); 
                
                loadRegisteredTeams();

                let friendlyError = "Szerver hiba (" + (err.code || "Ismeretlen") + ": " + err.message + ")";
                
                if (err.code === 'permission-denied') {
                    friendlyError = "HIBA: Nincs jogosults√°god! (Ellen≈ërizd a Firestore Rules-t a konzolon)";
                } else if (err.code === 'unavailable') {
                    friendlyError = "HIBA: A szerver nem el√©rhet≈ë (T≈±zfal vagy h√°l√≥zati hiba)";
                }

                alertBox.textContent = friendlyError + ". Mentve (Offline m√≥dban).";
                alertBox.className = "mb-4 p-4 rounded bg-yellow-500/20 border border-yellow-500 text-yellow-200 text-center block";
                alertBox.classList.remove('hidden');
                e.target.reset();
                setTimeout(() => alertBox.classList.add('hidden'), 8000);

            } finally {
                // Reset Button
                submitBtn.disabled = false;
                submitBtn.innerText = originalBtnText;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        document.getElementById('form-solo').addEventListener('submit', (e) => handleRegistration(e, 'individual'));
        document.getElementById('form-team').addEventListener('submit', (e) => handleRegistration(e, 'team'));

        // --- UI HELPERS ---
        function switchTab(type) {
            if (type === 'solo') {
                document.getElementById('tab-solo').className = "pb-3 px-6 text-festiveRed border-b-2 border-festiveRed font-bold transition-all";
                document.getElementById('tab-team').className = "pb-3 px-6 text-gray-400 hover:text-white transition-all";
                document.getElementById('form-solo').classList.remove('hidden');
                document.getElementById('form-team').classList.add('hidden');
            } else {
                document.getElementById('tab-team').className = "pb-3 px-6 text-festiveRed border-b-2 border-festiveRed font-bold transition-all";
                document.getElementById('tab-solo').className = "pb-3 px-6 text-gray-400 hover:text-white transition-all";
                document.getElementById('form-team').classList.remove('hidden');
                document.getElementById('form-solo').classList.add('hidden');
            }
        }

        function showPage(pageId) {
            const home = document.getElementById('page-home');
            const raffle = document.getElementById('page-raffle');
            if (pageId === 'home') {
                home.classList.remove('hidden-page'); raffle.classList.add('hidden-page');
                setTimeout(() => home.style.opacity = 1, 50);
            } else {
                home.classList.add('hidden-page'); raffle.classList.remove('hidden-page');
                setTimeout(() => raffle.style.opacity = 1, 50);
                loadRegisteredTeams();
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function scrollToSection(id) {
            showPage('home');
            setTimeout(() => { const el = document.getElementById(id); if(el) el.scrollIntoView({behavior: 'smooth'}); }, 100);
        }
        
        // --- RAFFLE ---
        function loadRegisteredTeams() {
            const teams = registrations.filter(r => r.type === 'team').map(r => r.teamName);
            const individuals = registrations.filter(r => r.type === 'individual').map(r => r.name);
            let text = teams.join('\n');
            if(individuals.length) text += '\n' + individuals.join('\n');
            if(!text) text = "M√©g nincs regisztr√°lt csapat.";
            document.getElementById('raffle-pool').value = text;
            document.getElementById('pool-count').innerText = (teams.length + individuals.length) + " db";
        }
        
        function startDraw() {
            const text = document.getElementById('raffle-pool').value;
            const pool = text.split('\n').filter(l => l.trim().length > 0 && l !== "M√©g nincs regisztr√°lt csapat.");
            if(pool.length < 2) return alert("Kev√©s a csapat!");
            
            document.getElementById('draw-btn').disabled = true;
            let i = 0;
            const interval = setInterval(() => {
                document.getElementById('slot-1').innerText = pool[Math.floor(Math.random()*pool.length)];
                document.getElementById('slot-2').innerText = pool[Math.floor(Math.random()*pool.length)];
                i++;
                if(i>20) {
                    clearInterval(interval);
                    const idx1 = Math.floor(Math.random()*pool.length);
                    let idx2 = Math.floor(Math.random()*pool.length);
                    while(idx1===idx2) idx2 = Math.floor(Math.random()*pool.length);
                    
                    const t1 = pool[idx1];
                    const t2 = pool[idx2];
                    document.getElementById('slot-1').innerText = t1;
                    document.getElementById('slot-2').innerText = t2;
                    
                    const overlay = document.getElementById('match-announcement');
                    document.getElementById('announced-match').innerHTML = `${t1} <br><span class="text-festiveRed">VS</span><br> ${t2}`;
                    overlay.classList.remove('hidden');
                    setTimeout(() => overlay.classList.remove('scale-0'), 10);
                    
                    addNewMatchFromRaffle(t1, t2);
                    
                    setTimeout(() => {
                        overlay.classList.add('scale-0');
                        setTimeout(() => overlay.classList.add('hidden'), 500);
                        document.getElementById('draw-btn').disabled = false;
                    }, 3000);
                }
            }, 100);
        }

        async function addNewMatchFromRaffle(t1, t2) {
             const newMatch = { t1, t2, s1: 0, s2: 0, status: "Kisorsolva", timestamp: Date.now() };
             if(isOnline && !isUsingLocalStorage) await db.collection('matches').add(newMatch);
             else { 
                 newMatch.id = Date.now().toString();
                 matchesData.push(newMatch); 
                 localStorage.setItem('musz_matches', JSON.stringify(matchesData));
                 renderAll();
             }
        }

        // --- ADMIN LOGIN ---
        function openAdminModal() { document.getElementById('admin-login-modal').classList.remove('hidden'); }
        function closeAdminModal() { document.getElementById('admin-login-modal').classList.add('hidden'); }
        function checkAdminPassword() {
            if(document.getElementById('admin-password').value === 'admin') {
                closeAdminModal();
                document.getElementById('admin-panel').classList.remove('hidden');
                document.getElementById('admin-panel').scrollIntoView({behavior:'smooth'});
                renderAdminMatches();
                renderAdminRegistrations();
            } else alert("Hib√°s jelsz√≥!");
        }
        function closeAdminPanel() { document.getElementById('admin-panel').classList.add('hidden'); window.scrollTo(0,0); }

        // --- 3D ---
        function init3D() {
            const container = document.getElementById('canvas-container');
            if(!container) return;
            const scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x0b0f19, 0.05);
            const camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 15, 20); camera.lookAt(0,0,0);
            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.innerHTML = ''; // Clear previous if any
            container.appendChild(renderer.domElement);
            
            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const dl = new THREE.DirectionalLight(0xffffff, 0.8); dl.position.set(10, 20, 10); scene.add(dl);
            const spotLight = new THREE.PointLight(0xe63946, 1, 20); spotLight.position.set(0, 5, 0); scene.add(spotLight);

            // Table Group
            const tableGroup = new THREE.Group(); scene.add(tableGroup);

            // Field
            const field = new THREE.Mesh(new THREE.BoxGeometry(14, 0.2, 8), new THREE.MeshLambertMaterial({color: 0x2d6a4f}));
            tableGroup.add(field);

            // Walls
            const woodMat = new THREE.MeshLambertMaterial({ color: 0x8B4513 });
            const longWallGeo = new THREE.BoxGeometry(15, 2, 0.5);
            const shortWallGeo = new THREE.BoxGeometry(0.5, 2, 8);
            
            const w1 = new THREE.Mesh(longWallGeo, woodMat); w1.position.set(0, 1, 4.25); tableGroup.add(w1);
            const w2 = new THREE.Mesh(longWallGeo, woodMat); w2.position.set(0, 1, -4.25); tableGroup.add(w2);
            const w3 = new THREE.Mesh(shortWallGeo, woodMat); w3.position.set(7.25, 1, 0); tableGroup.add(w3);
            const w4 = new THREE.Mesh(shortWallGeo, woodMat); w4.position.set(-7.25, 1, 0); tableGroup.add(w4);

            // Legs
            const legGeo = new THREE.BoxGeometry(1, 6, 1);
            const l1 = new THREE.Mesh(legGeo, woodMat); l1.position.set(6, -3, 3); tableGroup.add(l1);
            const l2 = new THREE.Mesh(legGeo, woodMat); l2.position.set(6, -3, -3); tableGroup.add(l2);
            const l3 = new THREE.Mesh(legGeo, woodMat); l3.position.set(-6, -3, 3); tableGroup.add(l3);
            const l4 = new THREE.Mesh(legGeo, woodMat); l4.position.set(-6, -3, -3); tableGroup.add(l4);

            // Rods Logic
            const rodGeo = new THREE.CylinderGeometry(0.1, 0.1, 10);
            const rodMat = new THREE.MeshStandardMaterial({ color: 0xcccccc, metalness: 0.8, roughness: 0.2 });
            const pRedMat = new THREE.MeshLambertMaterial({ color: 0xe63946 });
            const pBlueMat = new THREE.MeshLambertMaterial({ color: 0x1e3a8a });
            const playerGeo = new THREE.BoxGeometry(0.4, 1.5, 0.4);

            function createRod(x, playerColor, count) {
                const rod = new THREE.Mesh(rodGeo, rodMat);
                rod.rotation.x = Math.PI / 2;
                rod.position.y = 1.5;
                rod.position.x = x;
                const spacing = 6 / (count + 1);
                for(let i=1; i<=count; i++) {
                    const p = new THREE.Mesh(playerGeo, playerColor);
                    p.position.y = 0; 
                    p.position.z = -3 + (i * spacing);
                    p.rotation.x = -Math.PI / 2;
                    rod.add(p);
                }
                return rod;
            }

            const r1 = createRod(-5, pRedMat, 1);
            const r2 = createRod(-3, pRedMat, 2);
            const r3 = createRod(-1, pBlueMat, 3);
            const r4 = createRod(1, pRedMat, 5);
            const r5 = createRod(3, pBlueMat, 5);
            const r6 = createRod(5, pBlueMat, 2);
            tableGroup.add(r1, r2, r3, r4, r5, r6);

            // Snow
            const snowGeo = new THREE.BufferGeometry();
            const snowCount = 800;
            const pos = new Float32Array(snowCount*3);
            for(let i=0; i<snowCount*3; i++) pos[i] = (Math.random()-0.5)*60;
            snowGeo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            const snowMat = new THREE.PointsMaterial({ size: 0.2, color: 0xffffff, transparent: true, opacity: 0.6 });
            const snow = new THREE.Points(snowGeo, snowMat);
            scene.add(snow);

            // Animation
            let mouseX = 0, mouseY = 0;
            function animate() {
                requestAnimationFrame(animate);
                
                tableGroup.rotation.y += 0.002;
                tableGroup.rotation.x = 0.2 + (mouseY * 0.0005);
                tableGroup.rotation.y += mouseX * 0.0005;

                // Spin rods
                [r1,r2,r3,r4,r5,r6].forEach(r => r.rotation.y += 0.05);

                // Snow
                const p = snow.geometry.attributes.position.array;
                for(let i=1; i<p.length; i+=3) {
                    p[i] -= 0.1;
                    if(p[i] < -20) p[i] = 20;
                }
                snow.geometry.attributes.position.needsUpdate = true;

                renderer.render(scene, camera);
            }

            document.addEventListener('mousemove', e => {
                mouseX = e.clientX - window.innerWidth/2;
                mouseY = e.clientY - window.innerHeight/2;
            });
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth/window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
            animate();
        }

        window.onload = () => { 
            // Safety check for Three.js
            if(typeof THREE === 'undefined') {
                console.error("Three.js not loaded.");
            } else {
                init3D(); 
            }
        };
    </script>
</body>
</html>
