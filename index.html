<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√öSZ Cs√≥cs√≥ Bajnoks√°g</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- Firebase SDKs (Version 9 compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        // --- 1. CONFIGURATION (UPDATED) ---
        const firebaseConfig = {
            apiKey: "AIzaSyD0Ptqxehpi3_LzGPcTNMwGnAGgqyU5cro",
            authDomain: "karacsonyi-csocso.firebaseapp.com",
            projectId: "karacsonyi-csocso",
            storageBucket: "karacsonyi-csocso.firebasestorage.app",
            messagingSenderId: "541085489834",
            appId: "1:541085489834:web:790c95e5dff50ffd80ced3",
            measurementId: "G-TLS2S2PR71"
        };

        // --- GLOBAL STATE ---
        let matchesData = [];
        let rulesData = ["Szab√°ly 1...", "Szab√°ly 2...", "Szab√°ly 3...", "Szab√°ly 4..."];
        let registrations = [];
        let db = null;
        let isOnline = false;

        // --- ERROR HANDLER ---
        window.onerror = function(msg, url, line, col, error) {
            // Prevent alerting for every small thing, but log crucial connection errors
            if(msg.includes('renderStandings')) alert("Rendszer Hiba: " + msg);
            return false;
        };

        // --- INIT FIREBASE ---
        if (typeof firebase !== 'undefined' && firebaseConfig.apiKey) {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                // FIX FOR CORPORATE FIREWALLS
                // Changed to AutoDetect which is often more reliable than Force
                try {
                    db.settings({ 
                        experimentalAutoDetectLongPolling: true,
                        useFetchStreams: false 
                    });
                } catch(err) { console.log("Settings error (ignorable):", err); }
                
                const auth = firebase.auth();
                auth.signInAnonymously().then(() => {
                    console.log("Connected to Database");
                    isOnline = true;
                    const statusEl = document.getElementById('db-status');
                    if(statusEl) {
                        statusEl.innerHTML = 'üü¢ Adatb√°zis: Kapcsol√≥dva';
                        statusEl.className = 'text-xs font-mono mt-2 text-green-500';
                    }
                    startListeners();
                }).catch(e => {
                    console.error("Auth failed", e);
                    const statusEl = document.getElementById('db-status');
                    if(statusEl) {
                        statusEl.innerHTML = 'üî¥ Adatb√°zis: Hiba (Auth - Enged√©lyezd az Anonymoust!)';
                        statusEl.className = 'text-xs font-mono mt-2 text-red-500';
                    }
                });
            } catch(e) { console.error("Firebase init failed", e); alert("Firebase Init Hiba: " + e.message); }
        } else {
            console.warn("No Firebase Config or SDK! Using LocalStorage only.");
            // Load LocalStorage fallback
            const savedM = localStorage.getItem('musz_matches');
            if (savedM) matchesData = JSON.parse(savedM);
            const savedR = localStorage.getItem('musz_rules');
            if (savedR) rulesData = JSON.parse(savedR);
            const savedReg = localStorage.getItem('musz_registrations');
            if (savedReg) registrations = JSON.parse(savedReg);
            
            setTimeout(renderAll, 500); 
        }

        // --- REALTIME LISTENERS ---
        function startListeners() {
            // Matches
            db.collection('matches').orderBy('timestamp', 'asc').onSnapshot(snapshot => {
                matchesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAll();
            });

            // Registrations
            db.collection('registrations').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
                registrations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAdminRegistrations();
                loadRegisteredTeams(); // Update raffle pool automatically
            });

            // Rules
            db.collection('settings').doc('rules').onSnapshot(doc => {
                if (doc.exists) {
                    rulesData = doc.data().list;
                    renderAll();
                } else {
                    // Seed initial rules if missing
                    db.collection('settings').doc('rules').set({ list: rulesData });
                }
            });
        }

        // --- DIAGNOSTICS ---
        async function runDiagnostics() {
            if (!db) { alert("HIBA: Firebase nincs inicializ√°lva."); return; }
            
            let report = "DIAGNOSZTIKA:\n";
            
            // 1. Auth Check
            const user = firebase.auth().currentUser;
            report += `1. Bel√©pve: ${user ? 'IGEN (UID: ' + user.uid.substring(0,5) + '...)' : 'NEM'}\n`;
            
            // 2. Write Check
            try {
                await db.collection('_diagnostics').add({ timestamp: Date.now(), user: user ? user.uid : 'anon' });
                report += "2. √çr√°s teszt: SIKERES ‚úÖ\n";
            } catch (err) {
                report += `2. √çr√°s teszt: SIKERTELEN ‚ùå\n   K√≥d: ${err.code}\n   √úzenet: ${err.message}\n`;
                if(err.code === 'permission-denied') {
                    report += "\n>>> MEGOLD√ÅS: A Firestore Rules nincs 'Test Mode'-ban. √Åll√≠tsd 'allow read, write: if true;'-ra a konzolon! <<<\n";
                }
            }

            alert(report);
        }

        // --- RENDER FUNCTIONS ---
        function renderAll() {
            renderMatches();
            renderStandings(); 
            renderRules();
            if(!document.getElementById('admin-panel').classList.contains('hidden')) {
                renderAdminMatches();
                renderAdminRules();
            }
        }

        function renderMatches() {
            const container = document.getElementById('matches-container');
            if(!container) return;
            container.innerHTML = matchesData.length ? matchesData.map(m => `
                <div class="glass-panel p-6 rounded-xl border-b-4 ${m.s1 > 0 || m.s2 > 0 ? 'border-green-500' : 'border-gray-700'} flex flex-col justify-between h-full">
                    <div class="flex justify-between items-start mb-6 border-b border-white/10 pb-3">
                        <span class="text-xs font-bold text-festiveGold uppercase tracking-widest">${m.status || 'Tervezett'}</span>
                        <span class="text-xs text-gray-400 font-mono">${m.time || ''}</span>
                    </div>
                    <div class="flex items-center justify-between gap-2">
                        <div class="flex-1 text-left"><div class="font-bold text-white text-lg leading-tight break-words">${m.t1}</div></div>
                        <div class="px-4 py-2 bg-black/40 rounded-lg border border-white/10 min-w-[80px] text-center shrink-0">
                            <span class="font-display font-bold text-3xl text-white tracking-widest">${m.s1}-${m.s2}</span>
                        </div>
                        <div class="flex-1 text-right"><div class="font-bold text-white text-lg leading-tight break-words">${m.t2}</div></div>
                    </div>
                </div>
            `).join('') : '<p class="text-gray-400 col-span-full text-center">Nincsenek akt√≠v meccsek.</p>';
        }

        function renderStandings() {
            const body = document.getElementById('standings-body');
            if(!body) return;
            body.innerHTML = '';

            const stats = {};
            
            const initTeam = (name) => {
                if (!stats[name]) stats[name] = { name, played: 0, w: 0, l: 0, pts: 0 };
            };

            matchesData.forEach(m => {
                if(m.t1 && m.t2) {
                    initTeam(m.t1);
                    initTeam(m.t2);
                    
                    if (m.s1 > 0 || m.s2 > 0) { 
                        stats[m.t1].played++;
                        stats[m.t2].played++;
                        if (m.s1 > m.s2) {
                            stats[m.t1].w++;
                            stats[m.t1].pts += 3;
                            stats[m.t2].l++;
                        } else if (m.s2 > m.s1) {
                            stats[m.t2].w++;
                            stats[m.t2].pts += 3;
                            stats[m.t1].l++;
                        }
                    }
                }
            });

            const sortedTeams = Object.values(stats).sort((a,b) => b.pts - a.pts || b.w - a.w);

            if (sortedTeams.length === 0) {
                body.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500 italic">M√©g nincs lej√°tszott meccs.</td></tr>';
                return;
            }

            body.innerHTML = sortedTeams.map((t, i) => `
                <tr class="hover:bg-white/5 transition-colors">
                    <td class="p-4 font-bold ${i === 0 ? 'text-festiveGold' : 'text-gray-400'}">${i === 0 ? 'üëë ' : ''}#${i+1}</td>
                    <td class="p-4 font-medium text-white">${t.name}</td>
                    <td class="p-4 text-center text-gray-400">${t.played}</td>
                    <td class="p-4 text-center text-gray-400">${t.w}-${t.l}</td>
                    <td class="p-4 text-right font-bold text-festiveRed">${t.pts}</td>
                </tr>
            `).join('');
        }

        function renderRules() {
            rulesData.forEach((r, i) => { 
                const el = document.getElementById(`rule-${i}`);
                if(el) el.innerText = r;
            });
        }

        function renderAdminRegistrations() {
            const list = document.getElementById('admin-registrations-list');
            if(!list) return;
            if (registrations.length === 0) list.innerHTML = '<p class="italic">Nincs adat.</p>';
            else {
                list.innerHTML = registrations.map(r => `
                    <div class="border-b border-white/10 py-2">
                        <span class="text-festiveGold font-bold uppercase text-xs">[${r.type === 'team' ? 'CSAPAT' : 'EGY√âNI'}]</span>
                        <span class="text-white ml-2">${r.type === 'team' ? r.teamName : r.name}</span>
                    </div>
                `).join('');
            }
        }

        function renderAdminMatches() {
            const list = document.getElementById('admin-matches-list');
            if(!list) return;
            list.innerHTML = matchesData.map(m => `
                <div id="admin-row-${m.id}" class="flex flex-col md:flex-row items-center gap-4 bg-black/40 p-4 rounded border border-white/10">
                    <div class="w-full md:w-1/3"><input type="text" value="${m.t1}" id="team1-${m.id}" class="w-full bg-transparent text-festiveGold font-bold text-center md:text-left border-b border-white/10 outline-none"></div>
                    <div class="flex items-center gap-3 justify-center">
                        <input type="number" value="${m.s1}" id="score1-${m.id}" class="w-16 p-2 bg-gray-800 rounded text-center text-white font-bold text-xl">
                        <span class="text-gray-500">-</span>
                        <input type="number" value="${m.s2}" id="score2-${m.id}" class="w-16 p-2 bg-gray-800 rounded text-center text-white font-bold text-xl">
                    </div>
                    <div class="w-full md:w-1/3"><input type="text" value="${m.t2}" id="team2-${m.id}" class="w-full bg-transparent text-gray-300 font-bold text-center md:text-right border-b border-white/10 outline-none"></div>
                    <button onclick="saveMatch('${m.id}')" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded font-bold text-sm">OK</button>
                    <button onclick="deleteMatch('${m.id}')" class="text-red-500 hover:text-white px-2">X</button>
                </div>
            `).join('');
        }

        function renderAdminRules() {
             rulesData.forEach((r, i) => {
                 const el = document.getElementById(`admin-rule-${i}`);
                 if(el) el.value = r;
             });
        }

        // --- ACTIONS (DB WRITES) ---

        async function saveMatch(id) {
            const t1 = document.getElementById(`team1-${id}`).value;
            const t2 = document.getElementById(`team2-${id}`).value;
            const s1 = parseInt(document.getElementById(`score1-${id}`).value) || 0;
            const s2 = parseInt(document.getElementById(`score2-${id}`).value) || 0;
            
            const updateData = { t1, t2, s1, s2, status: (s1 > 0 || s2 > 0) ? 'V√©get √©rt' : 'Hamarosan' };

            if(isOnline) {
                await db.collection('matches').doc(id).update(updateData);
            } else {
                const idx = matchesData.findIndex(m => m.id === id);
                if(idx !== -1) matchesData[idx] = { ...matchesData[idx], ...updateData };
                localStorage.setItem('musz_matches', JSON.stringify(matchesData));
                renderAll();
            }
        }

        async function addNewMatch() {
            const newMatch = { t1: "Csapat A", t2: "Csapat B", s1: 0, s2: 0, status: "Tervezett", timestamp: Date.now() };
            if (isOnline) {
                await db.collection('matches').add(newMatch);
            } else {
                newMatch.id = Date.now().toString();
                matchesData.push(newMatch);
                localStorage.setItem('musz_matches', JSON.stringify(matchesData));
                renderAll();
            }
        }

        async function deleteMatch(id) {
             if(!confirm("Biztosan t√∂rl√∂d?")) return;
             if(isOnline) await db.collection('matches').doc(id).delete();
             else {
                 matchesData = matchesData.filter(m => m.id !== id);
                 localStorage.setItem('musz_matches', JSON.stringify(matchesData));
                 renderAll();
             }
        }

        async function saveRules() {
            const newRules = [
                document.getElementById('admin-rule-0').value,
                document.getElementById('admin-rule-1').value,
                document.getElementById('admin-rule-2').value,
                document.getElementById('admin-rule-3').value
            ];
            if(isOnline) {
                await db.collection('settings').doc('rules').set({ list: newRules });
            } else {
                rulesData = newRules;
                localStorage.setItem('musz_rules', JSON.stringify(rulesData));
            }
            alert("Szab√°lyok mentve!");
        }

        // UPDATED REGISTRATION HANDLER
        async function handleRegistration(e, type) {
            e.preventDefault();
            const alertBox = document.getElementById('form-alert');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerText;

            // UI Feedback: Loading
            submitBtn.disabled = true;
            submitBtn.innerText = "Ment√©s folyamatban...";
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
            
            let data = { type, timestamp: Date.now() };
            
            if (type === 'individual') {
                data.name = document.getElementById('solo-name').value;
                data.dept = document.getElementById('solo-dept').value;
            } else {
                data.teamName = document.getElementById('team-name').value;
                data.p1 = document.getElementById('p1-name').value;
                data.p2 = document.getElementById('p2-name').value;
            }

            try {
                if(isOnline) {
                    // Create a promise that rejects after 15 seconds (Extended)
                    const savePromise = db.collection('registrations').add(data);
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error("Timeout (15s)")), 15000)
                    );
                    
                    await Promise.race([savePromise, timeoutPromise]);
                } else {
                    throw new Error("Offline m√≥d."); 
                }

                // Success
                alertBox.textContent = "Sikeres regisztr√°ci√≥!";
                alertBox.className = "mb-4 p-4 rounded bg-green-500/20 border border-green-500 text-green-200 text-center block";
                alertBox.classList.remove('hidden');
                e.target.reset();
                setTimeout(() => alertBox.classList.add('hidden'), 3000);

            } catch (err) {
                console.error("Registration error:", err);
                
                // Fallback to LocalStorage if server fails
                registrations.push(data);
                localStorage.setItem('musz_registrations', JSON.stringify(registrations));
                loadRegisteredTeams();

                let friendlyError = "Szerver hiba (" + (err.code || "Ismeretlen") + ": " + err.message + ")";
                
                if (err.code === 'permission-denied') {
                    friendlyError = "HIBA: Nincs jogosults√°god! (Ellen≈ërizd a Firestore Rules-t a konzolon)";
                } else if (err.code === 'unavailable') {
                    friendlyError = "HIBA: A szerver nem el√©rhet≈ë (T≈±zfal vagy h√°l√≥zati hiba)";
                }

                alertBox.textContent = friendlyError + ". Mentve (Offline m√≥dban).";
                alertBox.className = "mb-4 p-4 rounded bg-yellow-500/20 border border-yellow-500 text-yellow-200 text-center block";
                alertBox.classList.remove('hidden');
                e.target.reset();
                setTimeout(() => alertBox.classList.add('hidden'), 8000);

            } finally {
                // Reset Button
                submitBtn.disabled = false;
                submitBtn.innerText = originalBtnText;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        document.getElementById('form-solo').addEventListener('submit', (e) => handleRegistration(e, 'individual'));
        document.getElementById('form-team').addEventListener('submit', (e) => handleRegistration(e, 'team'));

        // --- UI HELPERS ---
        function switchTab(type) {
            if (type === 'solo') {
                document.getElementById('tab-solo').className = "pb-3 px-6 text-festiveRed border-b-2 border-festiveRed font-bold transition-all";
                document.getElementById('tab-team').className = "pb-3 px-6 text-gray-400 hover:text-white transition-all";
                document.getElementById('form-solo').classList.remove('hidden');
                document.getElementById('form-team').classList.add('hidden');
            } else {
                document.getElementById('tab-team').className = "pb-3 px-6 text-festiveRed border-b-2 border-festiveRed font-bold transition-all";
                document.getElementById('tab-solo').className = "pb-3 px-6 text-gray-400 hover:text-white transition-all";
                document.getElementById('form-team').classList.remove('hidden');
                document.getElementById('form-solo').classList.add('hidden');
            }
        }

        function showPage(pageId) {
            const home = document.getElementById('page-home');
            const raffle = document.getElementById('page-raffle');
            if (pageId === 'home') {
                home.classList.remove('hidden-page'); raffle.classList.add('hidden-page');
                setTimeout(() => home.style.opacity = 1, 50);
            } else {
                home.classList.add('hidden-page'); raffle.classList.remove('hidden-page');
                setTimeout(() => raffle.style.opacity = 1, 50);
                loadRegisteredTeams();
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function scrollToSection(id) {
            showPage('home');
            setTimeout(() => { const el = document.getElementById(id); if(el) el.scrollIntoView({behavior: 'smooth'}); }, 100);
        }
        
        // --- RAFFLE ---
        function loadRegisteredTeams() {
            const teams = registrations.filter(r => r.type === 'team').map(r => r.teamName);
            const individuals = registrations.filter(r => r.type === 'individual').map(r => r.name);
            let text = teams.join('\n');
            if(individuals.length) text += '\n' + individuals.join('\n');
            if(!text) text = "M√©g nincs regisztr√°lt csapat.";
            document.getElementById('raffle-pool').value = text;
            document.getElementById('pool-count').innerText = (teams.length + individuals.length) + " db";
        }
        
        function startDraw() {
            const text = document.getElementById('raffle-pool').value;
            const pool = text.split('\n').filter(l => l.trim().length > 0 && l !== "M√©g nincs regisztr√°lt csapat.");
            if(pool.length < 2) return alert("Kev√©s a csapat!");
            
            document.getElementById('draw-btn').disabled = true;
            let i = 0;
            const interval = setInterval(() => {
                document.getElementById('slot-1').innerText = pool[Math.floor(Math.random()*pool.length)];
                document.getElementById('slot-2').innerText = pool[Math.floor(Math.random()*pool.length)];
                i++;
                if(i>20) {
                    clearInterval(interval);
                    const idx1 = Math.floor(Math.random()*pool.length);
                    let idx2 = Math.floor(Math.random()*pool.length);
                    while(idx1===idx2) idx2 = Math.floor(Math.random()*pool.length);
                    
                    const t1 = pool[idx1];
                    const t2 = pool[idx2];
                    document.getElementById('slot-1').innerText = t1;
                    document.getElementById('slot-2').innerText = t2;
                    
                    const overlay = document.getElementById('match-announcement');
                    document.getElementById('announced-match').innerHTML = `${t1} <br><span class="text-festiveRed">VS</span><br> ${t2}`;
                    overlay.classList.remove('hidden');
                    setTimeout(() => overlay.classList.remove('scale-0'), 10);
                    
                    addNewMatchFromRaffle(t1, t2);
                    
                    setTimeout(() => {
                        overlay.classList.add('scale-0');
                        setTimeout(() => overlay.classList.add('hidden'), 500);
                        document.getElementById('draw-btn').disabled = false;
                    }, 3000);
                }
            }, 100);
        }

        async function addNewMatchFromRaffle(t1, t2) {
             const newMatch = { t1, t2, s1: 0, s2: 0, status: "Kisorsolva", timestamp: Date.now() };
             if(isOnline) await db.collection('matches').add(newMatch);
             else { 
                 newMatch.id = Date.now().toString();
                 matchesData.push(newMatch); 
                 localStorage.setItem('musz_matches', JSON.stringify(matchesData));
                 renderAll();
             }
        }

        // --- ADMIN LOGIN ---
        function openAdminModal() { document.getElementById('admin-login-modal').classList.remove('hidden'); }
        function closeAdminModal() { document.getElementById('admin-login-modal').classList.add('hidden'); }
        function checkAdminPassword() {
            if(document.getElementById('admin-password').value === 'admin') {
                closeAdminModal();
                document.getElementById('admin-panel').classList.remove('hidden');
                document.getElementById('admin-panel').scrollIntoView({behavior:'smooth'});
                renderAdminMatches();
                renderAdminRegistrations();
            } else alert("Hib√°s jelsz√≥!");
        }
        function closeAdminPanel() { document.getElementById('admin-panel').classList.add('hidden'); window.scrollTo(0,0); }

        // --- 3D ---
        function init3D() {
            const container = document.getElementById('canvas-container');
            if(!container) return;
            const scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x0b0f19, 0.05);
            const camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 15, 20); camera.lookAt(0,0,0);
            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.innerHTML = ''; // Clear previous if any
            container.appendChild(renderer.domElement);
            
            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const dl = new THREE.DirectionalLight(0xffffff, 0.8); dl.position.set(10, 20, 10); scene.add(dl);
            const spotLight = new THREE.PointLight(0xe63946, 1, 20); spotLight.position.set(0, 5, 0); scene.add(spotLight);

            // Table Group
            const tableGroup = new THREE.Group(); scene.add(tableGroup);

            // Field
            const field = new THREE.Mesh(new THREE.BoxGeometry(14, 0.2, 8), new THREE.MeshLambertMaterial({color: 0x2d6a4f}));
            tableGroup.add(field);

            // Walls
            const woodMat = new THREE.MeshLambertMaterial({ color: 0x8B4513 });
            const longWallGeo = new THREE.BoxGeometry(15, 2, 0.5);
            const shortWallGeo = new THREE.BoxGeometry(0.5, 2, 8);
            
            const w1 = new THREE.Mesh(longWallGeo, woodMat); w1.position.set(0, 1, 4.25); tableGroup.add(w1);
            const w2 = new THREE.Mesh(longWallGeo, woodMat); w2.position.set(0, 1, -4.25); tableGroup.add(w2);
            const w3 = new THREE.Mesh(shortWallGeo, woodMat); w3.position.set(7.25, 1, 0); tableGroup.add(w3);
            const w4 = new THREE.Mesh(shortWallGeo, woodMat); w4.position.set(-7.25, 1, 0); tableGroup.add(w4);

            // Legs
            const legGeo = new THREE.BoxGeometry(1, 6, 1);
            const l1 = new THREE.Mesh(legGeo, woodMat); l1.position.set(6, -3, 3); tableGroup.add(l1);
            const l2 = new THREE.Mesh(legGeo, woodMat); l2.position.set(6, -3, -3); tableGroup.add(l2);
            const l3 = new THREE.Mesh(legGeo, woodMat); l3.position.set(-6, -3, 3); tableGroup.add(l3);
            const l4 = new THREE.Mesh(legGeo, woodMat); l4.position.set(-6, -3, -3); tableGroup.add(l4);

            // Rods Logic
            const rodGeo = new THREE.CylinderGeometry(0.1, 0.1, 10);
            const rodMat = new THREE.MeshStandardMaterial({ color: 0xcccccc, metalness: 0.8, roughness: 0.2 });
            const pRedMat = new THREE.MeshLambertMaterial({ color: 0xe63946 });
            const pBlueMat = new THREE.MeshLambertMaterial({ color: 0x1e3a8a });
            const playerGeo = new THREE.BoxGeometry(0.4, 1.5, 0.4);

            function createRod(x, playerColor, count) {
                const rod = new THREE.Mesh(rodGeo, rodMat);
                rod.rotation.x = Math.PI / 2;
                rod.position.y = 1.5;
                rod.position.x = x;
                const spacing = 6 / (count + 1);
                for(let i=1; i<=count; i++) {
                    const p = new THREE.Mesh(playerGeo, playerColor);
                    p.position.y = 0; 
                    p.position.z = -3 + (i * spacing);
                    p.rotation.x = -Math.PI / 2;
                    rod.add(p);
                }
                return rod;
            }

            const r1 = createRod(-5, pRedMat, 1);
            const r2 = createRod(-3, pRedMat, 2);
            const r3 = createRod(-1, pBlueMat, 3);
            const r4 = createRod(1, pRedMat, 5);
            const r5 = createRod(3, pBlueMat, 5);
            const r6 = createRod(5, pBlueMat, 2);
            tableGroup.add(r1, r2, r3, r4, r5, r6);

            // Snow
            const snowGeo = new THREE.BufferGeometry();
            const snowCount = 800;
            const pos = new Float32Array(snowCount*3);
            for(let i=0; i<snowCount*3; i++) pos[i] = (Math.random()-0.5)*60;
            snowGeo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            const snowMat = new THREE.PointsMaterial({ size: 0.2, color: 0xffffff, transparent: true, opacity: 0.6 });
            const snow = new THREE.Points(snowGeo, snowMat);
            scene.add(snow);

            // Animation
            let mouseX = 0, mouseY = 0;
            function animate() {
                requestAnimationFrame(animate);
                
                tableGroup.rotation.y += 0.002;
                tableGroup.rotation.x = 0.2 + (mouseY * 0.0005);
                tableGroup.rotation.y += mouseX * 0.0005;

                // Spin rods
                [r1,r2,r3,r4,r5,r6].forEach(r => r.rotation.y += 0.05);

                // Snow
                const p = snow.geometry.attributes.position.array;
                for(let i=1; i<p.length; i+=3) {
                    p[i] -= 0.1;
                    if(p[i] < -20) p[i] = 20;
                }
                snow.geometry.attributes.position.needsUpdate = true;

                renderer.render(scene, camera);
            }

            document.addEventListener('mousemove', e => {
                mouseX = e.clientX - window.innerWidth/2;
                mouseY = e.clientY - window.innerHeight/2;
            });
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth/window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
            animate();
        }

        window.onload = () => { 
            // Safety check for Three.js
            if(typeof THREE === 'undefined') {
                console.error("Three.js not loaded.");
            } else {
                init3D(); 
            }
        };
    </script>
</body>
</html>
