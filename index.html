<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MÚSZ Karácsonyi Csocsó Kupa</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Berkshire+Swash&family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-dark': '#0f131a',
                        'brand-red': '#ee3e38',
                        'brand-gold': '#facc15',
                        'brand-green': '#166534',
                        'glass': 'rgba(255, 255, 255, 0.05)'
                    },
                    fontFamily: {
                        sans: ['Montserrat', 'sans-serif'],
                        festive: ['Berkshire Swash', 'cursive'],
                    }
                }
            }
        }
    </script>

    <style>
        body { margin: 0; overflow-x: hidden; background-color: #0f131a; color: white; display: flex; flex-direction: column; min-height: 100vh; }
        
        /* 3D Canvas Background */
        #canvas-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0;
            background: radial-gradient(circle at center, #1a202c 0%, #0f131a 100%);
        }

        /* Nav gradient to blend with 3D scene */
        nav { background: linear-gradient(to bottom, rgba(15, 19, 26, 0.95), rgba(15, 19, 26, 0)); }
        .nav-garland { position: relative; z-index: 50; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f131a; }
        ::-webkit-scrollbar-thumb { background: #ee3e38; border-radius: 4px; }

        /* Typography & Effects */
        .title-glow { text-shadow: 0 0 25px rgba(250, 204, 21, 0.5); }

        /* Animations */
        .fade-in { animation: fadeIn 0.8s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Section Spacing */
        section { scroll-margin-top: 150px; }

        /* Glass Panels */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Layout Fixes */
        main { padding-top: 8rem; }
        #welcome { margin-top: 1rem; }
    </style>
</head>
<body class="font-sans antialiased text-gray-200">

    <div id="canvas-container"></div>

    <nav class="fixed top-0 w-full z-50 h-24 flex items-start pt-4 justify-between px-6 lg:px-12 nav-garland">
        
        <div class="flex items-center gap-3 z-50">
            <i class="fas fa-tree text-brand-green text-2xl drop-shadow-lg filter shadow-black"></i>
            <span class="font-festive text-2xl text-white tracking-widest drop-shadow-md"><span class="text-white">MÚSZ</span> <span class="text-brand-red">BAJNOKSÁG</span></span>
        </div>
        
        <div class="hidden md:flex gap-10 text-xs font-bold uppercase tracking-widest text-gray-300 z-50 mx-auto mt-2">
            <a href="#welcome" class="hover:text-brand-gold transition-colors duration-300 drop-shadow-md">Kezdőlap</a>
            <a href="#welcome" class="hover:text-brand-gold transition-colors duration-300 drop-shadow-md">Sorsolás</a>
            <a href="#meccsek-section" class="hover:text-brand-gold transition-colors duration-300 drop-shadow-md">Meccsek</a>
            <a href="#tabella-section" class="hover:text-brand-gold transition-colors duration-300 drop-shadow-md">Tabella</a>
        </div>
        
        <div class="w-8"></div>
    </nav>

    <main class="w-full flex-grow relative z-10 pb-20">
        
        <section id="welcome" class="min-h-[80vh] flex flex-col items-center justify-start pt-6 text-center px-4 relative">
            
            <div class="relative z-20 mb-8 fade-in" style="animation-delay: 0.1s;">
                <h1 class="font-festive text-4xl md:text-5xl text-white leading-tight drop-shadow-xl mb-2">
                    MÚSZ KARÁCSONYI
                </h1>
                <h1 class="font-festive text-6xl md:text-8xl text-brand-gold title-glow leading-tight drop-shadow-xl transform -rotate-1">
                    CSOCSÓ KUPA
                </h1>
            </div>

            <div class="z-20 fade-in" style="animation-delay: 0.2s;">
                <p class="text-gray-300 text-sm md:text-base max-w-lg mb-10 leading-relaxed bg-black/40 p-4 rounded-xl backdrop-blur-sm border border-white/10">
                    A hivatalos MÚSZ csocsó bajnokság visszatért! Regisztráljatok, pörgessétek fel az ünnepi hangulatot!
                </p>
            </div>

            <div class="z-20 fade-in" style="animation-delay: 0.3s;">
                <button onclick="document.getElementById('matches-list').scrollIntoView({behavior: 'smooth'})" class="bg-brand-red hover:bg-red-600 text-white font-bold uppercase tracking-wide text-sm px-8 py-4 rounded shadow-lg transition transform hover:scale-105 border border-red-400">
                    Meccsek Megtekintése
                </button>
            </div>

            <div class="mt-12 fade-in z-20" style="animation-delay: 0.4s;">
                <p class="text-gray-500 text-xs uppercase tracking-widest mb-2">Következő Mérkőzés</p>
                <div id="next-match-display" class="text-xl font-bold text-white bg-black/50 px-6 py-2 rounded border border-gray-700 backdrop-blur-md shadow-lg">
                    Jelenleg nincs aktív meccs
                </div>
            </div>

        </section>

        <div class="max-w-6xl mx-auto px-4 space-y-24 z-20 relative mt-20">

            <section id="meccsek-section">
                <div class="flex items-center gap-4 mb-8">
                    <h2 class="text-3xl font-bold text-white uppercase tracking-wider">Mérkőzések</h2>
                    <div class="h-1 flex-grow bg-gray-800 rounded"></div>
                </div>

                <div id="finals-container" class="mb-12 grid md:grid-cols-2 gap-6">
                    </div>

                <h3 class="text-brand-gold text-sm font-bold uppercase tracking-widest mb-4">Csoportkör</h3>
                <div id="matches-list" class="grid md:grid-cols-1 gap-3">
                    <div class="glass-panel p-6 rounded text-center text-gray-500 italic">
                        Nincs aktív menetrend. Generálj egyet az admin felületen.
                    </div>
                </div>
            </section>

            <section id="tabella-section">
                <div class="flex items-center gap-4 mb-8">
                    <h2 class="text-3xl font-bold text-white uppercase tracking-wider">Tabella</h2>
                    <div class="h-1 flex-grow bg-gray-800 rounded"></div>
                </div>
                
                <div class="glass-panel rounded-xl overflow-hidden shadow-2xl">
                    <table class="w-full text-left">
                        <thead class="bg-black/40 text-gray-400 text-xs uppercase tracking-wider font-bold">
                            <tr>
                                <th class="p-4">#</th>
                                <th class="p-4">Csapat</th>
                                <th class="p-4 text-center">M</th>
                                <th class="p-4 text-center">Gy</th>
                                <th class="p-4 text-center">V</th>
                                <th class="p-4 text-right">Pont</th>
                            </tr>
                        </thead>
                        <tbody id="standings-body" class="divide-y divide-gray-800 text-sm">
                            <tr><td colspan="6" class="p-8 text-center text-gray-500 italic">Nincs adat.</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="szabalyok-section">
                <div class="flex items-center gap-4 mb-8">
                    <h2 class="text-3xl font-bold text-white uppercase tracking-wider">Szabályzat</h2>
                    <div class="h-1 flex-grow bg-gray-800 rounded"></div>
                </div>
                <div class="glass-panel p-8 rounded-xl border-l-4 border-brand-red">
                    <ul id="rules-list" class="space-y-3 text-gray-300 list-disc list-inside"></ul>
                </div>
            </section>

        </div>
    </main>

    <footer class="bg-black/80 border-t border-gray-800 py-8 mt-auto text-center relative z-20">
        <div class="max-w-6xl mx-auto px-4 flex flex-col md:flex-row justify-between items-center text-gray-500 text-xs">
            <p>&copy; 2025 MÚSZ Bajnokság. Minden jog fenntartva.</p>
            
            <button onclick="openAdminModal()" class="mt-4 md:mt-0 hover:text-brand-gold transition flex items-center gap-2 group">
                <i class="fas fa-lock group-hover:text-brand-red"></i> 
                <span class="uppercase tracking-wider font-bold">Admin Belépés</span>
            </button>
        </div>
    </footer>

    <div id="admin-modal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/95 backdrop-blur-md">
        <div class="w-full max-w-2xl max-h-[90vh] overflow-y-auto bg-gray-900 border border-gray-700 rounded-xl p-8 relative shadow-2xl">
            <button onclick="closeAdminModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
            
            <h2 class="text-2xl font-bold text-white mb-6 border-b border-gray-700 pb-2">Adminisztráció</h2>

            <div id="admin-login-view">
                <label class="block text-xs uppercase text-gray-500 mb-2">Jelszó</label>
                <input type="password" id="admin-pass" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white mb-4 focus:border-brand-red focus:outline-none transition">
                <button onclick="adminLogin()" class="w-full bg-brand-red text-white font-bold py-3 rounded hover:bg-red-600 transition">Belépés</button>
                <p id="login-error" class="text-brand-red mt-2 text-sm hidden">Helytelen jelszó!</p>
            </div>

            <div id="admin-dashboard-view" class="hidden space-y-8">
                <div class="bg-black/30 p-4 rounded border border-gray-800">
                    <h3 class="text-white font-bold mb-3">1. Csapatok Generálása</h3>
                    <textarea id="player-input" rows="4" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-sm text-gray-300 mb-3 focus:outline-none" placeholder="Illeszd be a neveket (soronként 1 név)..."></textarea>
                    <button onclick="generateTournament()" class="bg-gray-700 hover:bg-gray-600 text-white w-full py-2 rounded text-sm font-bold transition">Sorsolás Indítása</button>
                </div>

                <div class="bg-black/30 p-4 rounded border border-gray-800">
                    <h3 class="text-white font-bold mb-3">2. Eredmények</h3>
                    <div id="admin-match-list" class="space-y-2 max-h-60 overflow-y-auto pr-2 custom-scrollbar"></div>
                </div>

                <div class="bg-black/30 p-4 rounded border border-gray-800">
                    <h3 class="text-white font-bold mb-3">3. Szabályok</h3>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="new-rule-input" class="flex-1 bg-black/50 border border-gray-700 rounded p-2 text-sm text-white focus:outline-none" placeholder="Új szabály...">
                        <button onclick="addRule()" class="bg-brand-red px-3 rounded text-white hover:bg-red-600"><i class="fas fa-plus"></i></button>
                    </div>
                    <ul id="admin-rules-list" class="space-y-1 text-sm text-gray-400"></ul>
                </div>

                <div class="flex justify-end pt-4">
                    <span id="save-status" class="text-green-500 text-sm self-center mr-3 opacity-0 transition-opacity">Mentve!</span>
                    <button onclick="forceSave()" class="bg-brand-red text-white px-6 py-2 rounded font-bold hover:bg-red-600 transition">Mentés</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 3D SCENE: TWO PLAYERS KICKING A BALL + GARLAND + LOGO SNOW ---
        function initThreeJS() {
            const container = document.getElementById('canvas-container');
            const scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x0f131a, 0.04);

            const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 2, 14); 
            camera.lookAt(0, 1, 0);

            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);

            // === LIGHTING ===
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);
            
            const mainSpot = new THREE.SpotLight(0xffffff, 1.5);
            mainSpot.position.set(0, 10, 10);
            mainSpot.castShadow = true;
            scene.add(mainSpot);

            const redLight = new THREE.PointLight(0xee3e38, 0.8);
            redLight.position.set(-10, 5, 0);
            scene.add(redLight);
            const goldLight = new THREE.PointLight(0xfacc15, 0.8);
            goldLight.position.set(10, 5, 0);
            scene.add(goldLight);


            // === 3D GARLAND (Background) ===
            function createGarland() {
                const garlandGroup = new THREE.Group();
                const curve = new THREE.CatmullRomCurve3([
                    new THREE.Vector3(-16, 8, -4),
                    new THREE.Vector3(-8, 6, -4),
                    new THREE.Vector3(0, 7.5, -4),
                    new THREE.Vector3(8, 6, -4),
                    new THREE.Vector3(16, 8, -4)
                ]);

                const needleGeo = new THREE.ConeGeometry(0.1, 0.8, 5);
                const needleMat = new THREE.MeshStandardMaterial({ color: 0x166534, roughness: 0.8 });
                const count = 2500;
                const needles = new THREE.InstancedMesh(needleGeo, needleMat, count);
                const dummy = new THREE.Object3D();
                
                for(let i=0; i<count; i++) {
                    const t = i / count;
                    const pos = curve.getPoint(t);
                    pos.x += (Math.random() - 0.5) * 1.2;
                    pos.y += (Math.random() - 0.5) * 1.2;
                    pos.z += (Math.random() - 0.5) * 1.2;
                    dummy.position.copy(pos);
                    dummy.rotation.set(Math.random()*Math.PI, Math.random()*Math.PI, Math.random()*Math.PI);
                    dummy.scale.setScalar(0.5 + Math.random() * 0.5);
                    dummy.updateMatrix();
                    needles.setMatrixAt(i, dummy.matrix);
                }
                garlandGroup.add(needles);

                const ballGeo = new THREE.SphereGeometry(0.3, 16, 16);
                const redMat = new THREE.MeshStandardMaterial({ color: 0xee3e38, metalness: 0.6, roughness: 0.3 });
                const goldMat = new THREE.MeshStandardMaterial({ color: 0xfacc15, metalness: 0.7, roughness: 0.2 });
                
                const ornCount = 50;
                const redBalls = new THREE.InstancedMesh(ballGeo, redMat, ornCount/2);
                const goldBalls = new THREE.InstancedMesh(ballGeo, goldMat, ornCount/2);
                let r=0, g=0;
                for(let i=0; i<ornCount; i++) {
                    const t = Math.random();
                    const pos = curve.getPoint(t);
                    pos.y -= 0.4; pos.z += 0.4;
                    dummy.position.copy(pos); dummy.scale.setScalar(1); dummy.updateMatrix();
                    if(i%2==0) redBalls.setMatrixAt(r++, dummy.matrix);
                    else goldBalls.setMatrixAt(g++, dummy.matrix);
                }
                garlandGroup.add(redBalls); garlandGroup.add(goldBalls);
                return garlandGroup;
            }
            const garland = createGarland();
            scene.add(garland);


            // === PLAYERS & BALL ===
            const playersGroup = new THREE.Group();
            const redTeamMat = new THREE.MeshStandardMaterial({ color: 0xee3e38, roughness: 0.5 });
            const blueTeamMat = new THREE.MeshStandardMaterial({ color: 0x1e3a8a, roughness: 0.5 });
            const goldAccentMat = new THREE.MeshStandardMaterial({ color: 0xfacc15, metalness: 0.8, roughness: 0.3 });
            const skinMat = new THREE.MeshStandardMaterial({ color: 0xe0ac69, roughness: 0.6 });
            const ballMat = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.4 });

            const torsoGeo = new THREE.BoxGeometry(1, 1.5, 0.7);
            const headGeo = new THREE.SphereGeometry(0.6, 16, 16);
            const legGeo = new THREE.BoxGeometry(0.7, 1.8, 0.6);

            function createPlayer(teamMat) {
                const group = new THREE.Group();
                const torso = new THREE.Mesh(torsoGeo, teamMat); torso.position.y = 0.75; torso.castShadow = true; group.add(torso);
                const head = new THREE.Mesh(headGeo, skinMat); head.position.y = 1.8; head.castShadow = true; group.add(head);
                const legPivot = new THREE.Group(); legPivot.position.y = 0;
                const legs = new THREE.Mesh(legGeo, teamMat); legs.position.y = -0.9; legs.castShadow = true; legPivot.add(legs);
                group.add(legPivot);
                const stripe = new THREE.Mesh(new THREE.BoxGeometry(1.05, 0.2, 0.75), goldAccentMat); stripe.position.y = 0.5; group.add(stripe);
                return { mesh: group, legAnimator: legPivot };
            }

            const player1 = createPlayer(redTeamMat);
            player1.mesh.position.set(-4.5, -1, 0); player1.mesh.rotation.y = Math.PI / 2; playersGroup.add(player1.mesh);

            const player2 = createPlayer(blueTeamMat);
            player2.mesh.position.set(4.5, -1, 0); player2.mesh.rotation.y = -Math.PI / 2; playersGroup.add(player2.mesh);

            const ball = new THREE.Mesh(new THREE.SphereGeometry(0.3, 16, 16), ballMat);
            ball.position.set(0, -2.3, 0); ball.castShadow = true;
            playersGroup.add(ball);
            scene.add(playersGroup);

            // === PARTICLES (Standard Snow) ===
            const snowGeo = new THREE.BufferGeometry();
            const snowCount = 800;
            const posArray = new Float32Array(snowCount * 3);
            for(let i=0; i<snowCount*3; i++) posArray[i] = (Math.random() - 0.5) * 50;
            snowGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            const snowMat = new THREE.PointsMaterial({ size: 0.15, color: 0xffffff, transparent: true, opacity: 0.8 });
            const snowMesh = new THREE.Points(snowGeo, snowMat);
            scene.add(snowMesh);

            // === PARTICLES (Logo Snow) ===
            // Load the logo texture defined in the data URI below
            const logoTextureBtn = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAMAAACdt4HsAAAAn1BMVEUAAAA5WIs5WIo5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIs5WIrM3/49AAAAM3RSTlMAECBgMFAwQCCAcGCAgHCAgICA/4CAgID/gID/gP//gP//gID/gID/gICA/4CAgICAbN+4gAAAAe5JREFUeNrtl9magjAMhRULKqCgqKjd6v//wG07d30c26mDM/F98yVpQ5M2TRfL/kM4v9v0gP4z+CqgD1cAPgvgjQAeCyDmAaQYgDQDQAIAlQBgIQBQAAD3/wH81zF44wE4o78D/G554IsAwE8BvBMAjAGkFgBaCQCXAEg/APAaQFYAOADgAwDgA0C+B8D3AcDvAYA/AOA3AWAiAAABgC8A8DkAAAEA2ABgGQA+A+AnAeCTAHAdgPcD4BMA8BoA/gSAtwAgEAB8GgD+AgDnAeCnAGAXAIADAHAAAM4CwAUA2AUA+A4AAAD+AIAfAIBDAPA1AHwFAD4FAK4DAF8AgK8AwI8A4EMAcA0AtgAAlgAAPgYArwIA3wUArgD4MgB4GQAsBYCtAIB/AoCPAsC2AMCfAcDHAOA1APglALgBALcCAHYBANYDAB8EgIsAwEUAeCkAOAwAXQcAdwAAqwEArAEA6wAAiwHAZQD4IABwGQA4DgB+A4C/AQAbAwDvAMAmAOALAHgPAD4IAJYBwEYA+CIAcBoAdgkAOAMAmwEAnwGAWwDwDgC8BwDbAQCfBoCdAgDvAYB3AOAbAPARAFgIADsGAH4DAD4AANcAgM0BgA8BgE0BwHcAgH8BAJcAgJ0B/jW+ACF3Gf/F7Y1QAAAAAElFTkSuQmCC';
            const textureLoader = new THREE.TextureLoader();
            const logoTexture = textureLoader.load(logoTextureBtn);

            const logoSnowGeo = new THREE.BufferGeometry();
            const logoSnowCount = 100; // Fewer logo flakes than regular snow
            const logoPosArray = new Float32Array(logoSnowCount * 3);
            for(let i=0; i<logoSnowCount*3; i++) logoPosArray[i] = (Math.random() - 0.5) * 50;
            logoSnowGeo.setAttribute('position', new THREE.BufferAttribute(logoPosArray, 3));
            // Use PointsMaterial with the texture, set transparent to true so the alpha channel works
            const logoSnowMat = new THREE.PointsMaterial({ size: 1.5, map: logoTexture, transparent: true, opacity: 0.9, depthWrite: false });
            const logoSnowMesh = new THREE.Points(logoSnowGeo, logoSnowMat);
            scene.add(logoSnowMesh);


            // === ANIMATION VARIABLES & LOOP ===
            let mouseX = 0, mouseY = 0;
            
            // Ball Animation State
            let ballTargetX = -3.8; // Initial target (Player 1's side)
            let ballCurrentSpeed = 0.05;

            const animate = () => {
                requestAnimationFrame(animate);

                // Sway garland
                garland.rotation.z = Math.sin(Date.now() * 0.0005) * 0.02;

                // --- RANDOMIZED BALL MOVEMENT ---
                // Move ball towards current target
                const targetVec = new THREE.Vector3(ballTargetX, -2.3, 0);
                ball.position.lerp(targetVec, ballCurrentSpeed);
                // Add slight random vertical bounce
                ball.position.y = -2.3 + Math.abs(Math.sin(Date.now() * 0.005)) * 0.2;

                // Check distance to target to trigger kick and new target
                if (ball.position.distanceTo(targetVec) < 0.3) {
                    // Ball arrived at a player
                    if (ballTargetX < 0) {
                        // Player 1 (Left) kicks
                        player1.legAnimator.rotation.x = -1; // kick forward
                        // Set new random target for Player 2 (Right side)
                        ballTargetX = 3.5 + Math.random() * 1.0; 
                    } else {
                        // Player 2 (Right) kicks
                        player2.legAnimator.rotation.x = 1; // kick forward
                        // Set new random target for Player 1 (Left side)
                        ballTargetX = -3.5 - Math.random() * 1.0;
                    }
                    // Randomize speed for next pass
                    ballCurrentSpeed = 0.03 + Math.random() * 0.05;
                }

                // Smoothly retract legs back to neutral position
                player1.legAnimator.rotation.x *= 0.9;
                player2.legAnimator.rotation.x *= 0.9;


                // Camera Parallax
                camera.position.x += (mouseX * 5 - camera.position.x) * 0.05;
                camera.position.y += (-mouseY * 2 + 2 - camera.position.y) * 0.05;
                camera.lookAt(0, 0, 0);

                // --- UPDATE SNOW (Standard) ---
                const snowPositions = snowMesh.geometry.attributes.position.array;
                for(let i=1; i<snowCount*3; i+=3) {
                    snowPositions[i] -= 0.05; // Fall down
                    if(snowPositions[i] < -25) snowPositions[i] = 25; // Reset to top
                }
                snowMesh.geometry.attributes.position.needsUpdate = true;

                // --- UPDATE SNOW (Logo) ---
                const logoPositions = logoSnowMesh.geometry.attributes.position.array;
                for(let i=1; i<logoSnowCount*3; i+=3) {
                    logoPositions[i] -= 0.07; // Fall slightly faster/differently
                    // Add slight horizontal drift for variance
                    logoPositions[i-1] += Math.sin(Date.now()*0.001 + i)*0.01; 
                    if(logoPositions[i] < -25) {
                        logoPositions[i] = 25;
                        logoPositions[i-1] = (Math.random() - 0.5) * 50; // Reset X randomly
                    }
                }
                logoSnowMesh.geometry.attributes.position.needsUpdate = true;

                renderer.render(scene, camera);
            };

            animate();
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
            document.addEventListener('mousemove', (e) => {
                mouseX = (e.clientX / window.innerWidth) - 0.5;
                mouseY = (e.clientY / window.innerHeight) - 0.5;
            });
        }

        // --- APP LOGIC (Preserved) ---
        const funnyNames = ["Részeg Rénszarvasok", "Beigli Betyárok", "Grincs Gárdája", "Forralt Bor FC", "Hólapátolók", "Kevinék", "Reszkessetek", "Jéghercegnők", "Krampusz United", "Diós Bejgli"];
        let state = { teams: [], matches: [], rules: ["Nincs döntetlen (10 gólig tart a meccs).", "A pörgetés tilos.", "Fair play mindenek felett.", "Gól után középkezdés."], generated: false };

        window.onload = function() { initThreeJS(); loadData(); };

        function loadData() {
            const local = localStorage.getItem('foosball_data');
            if (local) { state = JSON.parse(local); renderAll(); }
            if (typeof db !== 'undefined') {
                db.ref('tournament').on('value', (s) => {
                    const d = s.val();
                    if (d) { state = d; renderAll(); localStorage.setItem('foosball_data', JSON.stringify(state)); }
                });
            }
        }
        function saveData() {
            renderAll();
            localStorage.setItem('foosball_data', JSON.stringify(state));
            if (typeof db !== 'undefined') db.ref('tournament').set(state);
            const s = document.getElementById('save-status');
            s.style.opacity = '1'; setTimeout(() => s.style.opacity = '0', 2000);
        }

        function generateTournament() {
            const raw = document.getElementById('player-input').value.trim();
            if (!raw) return alert("Kérlek adj meg neveket!");
            let players = raw.split('\n').filter(n => n.trim().length > 0);
            for (let i = players.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [players[i], players[j]] = [players[j], players[i]];
            }
            const teams = [];
            const shuffledNames = [...funnyNames].sort(() => 0.5 - Math.random());
            let pIndex = 0, teamId = 1;
            while (pIndex < players.length) {
                let name = shuffledNames[teamId - 1] || `Csapat ${teamId}`;
                let members = (players.length - pIndex === 1) ? [players[pIndex], "VÁRAKOZÓ"] : [players[pIndex], players[pIndex+1]];
                teams.push({ id: teamId++, name: name, members: members, stats: { played:0, w:0, l:0, pts:0, gf:0, ga:0 }});
                pIndex += (players.length - pIndex === 1) ? 1 : 2;
            }
            let matches = [], matchId = 1;
            for (let i=0; i<teams.length; i++) {
                for (let j=i+1; j<teams.length; j++) {
                    matches.push({ id: matchId++, t1: teams[i].id, t2: teams[j].id, s1:null, s2:null, status:'scheduled', type:'group' });
                }
            }
            matches.sort(() => 0.5 - Math.random());
            matches.push({ id: 998, t1:null, t2:null, s1:null, s2:null, status:'scheduled', type:'bronze', label:'Bronzmeccs' });
            matches.push({ id: 999, t1:null, t2:null, s1:null, s2:null, status:'scheduled', type:'gold', label:'DÖNTŐ' });
            state.teams = teams; state.matches = matches; saveData();
        }

        function calculateStandings() {
            state.teams.forEach(t => t.stats = { played:0, w:0, l:0, pts:0, gf:0, ga:0 });
            const groups = state.matches.filter(m => m.type === 'group');
            let allPlayed = true;
            groups.forEach(m => {
                if (m.status !== 'played') { allPlayed = false; return; }
                const t1 = state.teams.find(t => t.id === m.t1);
                const t2 = state.teams.find(t => t.id === m.t2);
                if (!t1 || !t2) return;
                t1.stats.played++; t2.stats.played++;
                t1.stats.gf += parseInt(m.s1); t1.stats.ga += parseInt(m.s2);
                t2.stats.gf += parseInt(m.s2); t2.stats.ga += parseInt(m.s1);
                if (m.s1 > m.s2) { t1.stats.w++; t1.stats.pts += 3; t2.stats.l++; }
                else if (m.s2 > m.s1) { t2.stats.w++; t2.stats.pts += 3; t1.stats.l++; }
            });
            state.teams.sort((a,b) => b.stats.pts - a.stats.pts || (b.stats.gf - b.stats.ga) - (a.stats.gf - a.stats.ga));
            if (state.teams.length >= 4) {
                const bronze = state.matches.find(m => m.type === 'bronze');
                const gold = state.matches.find(m => m.type === 'gold');
                if (allPlayed && groups.length > 0) {
                    if (bronze && bronze.status !== 'played') { bronze.t1 = state.teams[2].id; bronze.t2 = state.teams[3].id; }
                    if (gold && gold.status !== 'played') { gold.t1 = state.teams[0].id; gold.t2 = state.teams[1].id; }
                } else {
                    if (bronze) { bronze.t1 = null; bronze.t2 = null; }
                    if (gold) { gold.t1 = null; gold.t2 = null; }
                }
            }
        }

        function renderAll() {
            calculateStandings();
            document.getElementById('rules-list').innerHTML = state.rules.map(r => `<li>${r}</li>`).join('');
            document.getElementById('admin-rules-list').innerHTML = state.rules.map((r,i) => `<li class="flex justify-between items-center bg-gray-800 p-2 rounded"><span>${r}</span><button onclick="deleteRule(${i})" class="text-red-500 hover:text-red-400"><i class="fas fa-trash"></i></button></li>`).join('');
            const tbody = document.getElementById('standings-body'); tbody.innerHTML = '';
            state.teams.forEach((t, i) => {
                let rowColor = i < 3 ? (i===0 ? 'text-brand-gold' : 'text-gray-200') : 'text-gray-500';
                tbody.innerHTML += `<tr class="hover:bg-white/5 transition"><td class="p-4 font-bold ${rowColor}">${i+1}.</td><td class="p-4"><div class="font-bold text-white">${t.name}</div><div class="text-xs text-gray-500">${t.members.join(' & ')}</div></td><td class="p-4 text-center text-gray-400">${t.stats.played}</td><td class="p-4 text-center text-green-400">${t.stats.w}</td><td class="p-4 text-center text-red-400">${t.stats.l}</td><td class="p-4 text-right font-bold text-white">${t.stats.pts}</td></tr>`;
            });
            const mList = document.getElementById('matches-list'); const fList = document.getElementById('finals-container');
            mList.innerHTML = ''; fList.innerHTML = '';
            const groups = state.matches.filter(m => m.type === 'group');
            const finals = state.matches.filter(m => m.type !== 'group');
            const nextMatch = state.matches.find(m => m.status === 'scheduled' && m.t1 && m.t2);
            document.getElementById('next-match-display').innerHTML = nextMatch ? `<span class="text-white">${state.teams.find(t=>t.id===nextMatch.t1).name}</span> <span class="text-brand-red mx-2">vs</span> <span class="text-white">${state.teams.find(t=>t.id===nextMatch.t2).name}</span>` : "Nincs aktív meccs / Vége";
            groups.forEach(m => {
                const t1 = state.teams.find(t=>t.id===m.t1); const t2 = state.teams.find(t=>t.id===m.t2);
                if(!t1 || !t2) return;
                const score = m.status === 'played' ? `<span class="text-xl font-bold text-brand-red">${m.s1} - ${m.s2}</span>` : `<span class="text-xs bg-gray-700 px-2 py-1 rounded">VS</span>`;
                mList.innerHTML += `<div class="glass-panel p-4 rounded flex justify-between items-center ${m.status==='played'?'opacity-50':''}"><div class="flex-1 text-right pr-4 font-bold text-gray-300">${t1.name}</div><div class="w-20 text-center">${score}</div><div class="flex-1 text-left pl-4 font-bold text-gray-300">${t2.name}</div></div>`;
            });
            finals.sort((a,b) => b.type==='gold'?1:-1).forEach(m => {
                const t1 = state.teams.find(t=>t.id===m.t1); const t2 = state.teams.find(t=>t.id===m.t2);
                const borderColor = m.type==='gold' ? 'border-brand-gold' : 'border-orange-700';
                let content = `<div class="text-gray-500 italic text-sm">Várakozás a csapatokra...</div>`;
                if(t1 && t2) { content = `<div class="flex justify-between items-center mt-2"><span class="font-bold text-white text-lg">${t1.name}</span>${m.status==='played' ? `<span class="text-2xl font-bold text-brand-red mx-2">${m.s1}-${m.s2}</span>` : '<span class="text-xs text-gray-500 mx-2">VS</span>'}<span class="font-bold text-white text-lg">${t2.name}</span></div>`; }
                fList.innerHTML += `<div class="glass-panel p-6 rounded border-t-4 ${borderColor} relative"><div class="absolute top-2 right-2 text-[10px] uppercase font-bold tracking-widest ${m.type==='gold'?'text-brand-gold':'text-orange-500'}">${m.label}</div>${content}</div>`;
            });
            const aList = document.getElementById('admin-match-list'); aList.innerHTML = '';
            state.matches.forEach(m => {
                const t1 = state.teams.find(t=>t.id===m.t1); const t2 = state.teams.find(t=>t.id===m.t2);
                if((!t1 || !t2) && m.type==='group') return; if(!t1 && m.type!=='group') return;
                aList.innerHTML += `<div class="flex items-center gap-2 bg-gray-800 p-2 rounded text-xs mb-1"><span class="w-6 text-gray-500">#${m.id}</span><span class="flex-1 text-right truncate text-gray-300">${t1?t1.name:'?'}</span><input type="number" onchange="updateScore(${m.id},'s1',this.value)" value="${m.s1??''}" class="w-8 bg-black text-white text-center border border-gray-600 rounded"><span>-</span><input type="number" onchange="updateScore(${m.id},'s2',this.value)" value="${m.s2??''}" class="w-8 bg-black text-white text-center border border-gray-600 rounded"><span class="flex-1 text-left truncate text-gray-300">${t2?t2.name:'?'}</span></div>`;
            });
        }

        function updateScore(id, f, v) { const m = state.matches.find(x=>x.id===id); if(m) { m[f] = v===""?null:parseInt(v); m.status = (m.s1!==null && m.s2!==null) ? 'played' : 'scheduled'; } }
        function addRule() { const i = document.getElementById('new-rule-input'); if(i.value.trim()){ state.rules.push(i.value.trim()); i.value=''; saveData(); } }
        function deleteRule(i) { state.rules.splice(i,1); saveData(); }
        function openAdminModal() { document.getElementById('admin-modal').classList.remove('hidden'); document.getElementById('admin-modal').classList.add('flex'); }
        function closeAdminModal() { document.getElementById('admin-modal').classList.add('hidden'); document.getElementById('admin-modal').classList.remove('flex'); }
        function adminLogin() { if(document.getElementById('admin-pass').value === 'Jimmy92') { document.getElementById('admin-login-view').classList.add('hidden'); document.getElementById('admin-dashboard-view').classList.remove('hidden'); renderAll(); } else { document.getElementById('login-error').classList.remove('hidden'); } }
    </script>
</body>
</html>
