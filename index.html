<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Winter Corporate Foosball</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gold: '#D4AF37',
                        'deep-red': '#8B0000',
                        'void-black': '#050505',
                        'glass': 'rgba(255, 255, 255, 0.05)'
                    },
                    fontFamily: {
                        sans: ['Helvetica Neue', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body { margin: 0; overflow-x: hidden; background-color: #000; color: white; display: flex; flex-direction: column; min-height: 100vh; }
        
        /* 3D Canvas Background */
        #canvas-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -1;
            /* Added radial gradient for depth */
            background: radial-gradient(circle at center, #1a0505 0%, #000000 100%);
        }

        /* Glassmorphism Classes - Increased blur and border contrast */
        .glass-panel {
            background: rgba(20, 20, 20, 0.7);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(212, 175, 55, 0.3); 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8); /* Stronger shadow */
        }

        .glass-nav {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(212, 175, 55, 0.5);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #D4AF37; border-radius: 4px; }

        /* Festive Glowing Effects */
        .gold-glow { text-shadow: 0 0 15px rgba(212, 175, 55, 0.8), 0 0 25px rgba(212, 175, 55, 0.4); }
        .red-accent { color: #8B0000; }

        /* Animation for subtle element entry */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom styles for 3D field placement */
        #threejs-display {
            position: relative;
            width: 100%;
            height: 400px; /* Fixed height for the 3D area */
            margin-top: -120px; /* Pulls the canvas up under the welcome text */
            z-index: 1;
        }

        /* Ensure fixed nav doesn't cover content */
        main { padding-top: 6rem; padding-bottom: 3rem; }
    </style>
</head>
<body class="font-sans antialiased text-gray-200">

    <div id="canvas-container"></div>

    <nav class="fixed top-0 w-full z-50 glass-nav h-16 flex items-center justify-center px-4 lg:px-8">
        <div class="absolute left-4 flex items-center gap-2">
            <i class="fas fa-snowflake text-gold animate-pulse"></i>
            <span class="font-bold text-xl tracking-wider text-white">WINTER <span class="text-gold">CUP</span></span>
        </div>
        
        <div class="flex gap-8 text-sm uppercase tracking-widest font-bold">
            <a href="#welcome" class="hover:text-gold transition-colors duration-300">Home</a>
            <a href="#tabella-section" class="hover:text-gold transition-colors duration-300">Tabella</a>
            <a href="#meccsek-section" class="hover:text-gold transition-colors duration-300">Meccsek</a>
            <a href="#szabalyok-section" class="hover:text-gold transition-colors duration-300">Szabályok</a>
        </div>

        </nav>

    <main class="max-w-6xl mx-auto flex-grow w-full space-y-20">
        
        <section id="welcome" class="text-center fade-in pt-10">
            <h1 class="text-6xl md:text-8xl font-black mb-4 gold-glow text-white">TÉLI CSOCSÓ KUPA</h1>
            <p class="text-2xl text-gray-300 mb-8 font-serif italic">Üdvözlünk a vállalati bajnokságon!</p>
            
            <div class="inline-block glass-panel p-4 rounded-lg border-l-4 border-deep-red">
                <p class="text-gold uppercase text-sm tracking-widest font-bold mb-2">Következő Meccs</p>
                <div id="next-match-display" class="text-xl font-bold">Jelenleg nincs aktív meccs</div>
            </div>
            
            <div id="threejs-display"></div>
        </section>

        <div class="border-t-2 border-dashed border-gold/50 mx-10"></div>

        <section id="tabella-section" class="fade-in scroll-mt-24">
            <h2 class="text-4xl font-bold text-gold mb-6 border-b-2 border-deep-red pb-2 flex items-center gap-3">
                <i class="fas fa-trophy red-accent"></i> Tabella
            </h2>
            <div class="glass-panel rounded-xl overflow-hidden min-h-[200px] flex items-center justify-center">
                <table class="w-full text-left border-collapse" id="standings-table">
                    <thead>
                        <tr class="bg-black/50 text-gold uppercase text-sm tracking-wider">
                            <th class="p-4">#</th>
                            <th class="p-4">Csapat</th>
                            <th class="p-4 text-center">M</th>
                            <th class="p-4 text-center">Gy</th>
                            <th class="p-4 text-center">D</th>
                            <th class="p-4 text-center">V</th>
                            <th class="p-4 text-right">Pont</th>
                        </tr>
                    </thead>
                    <tbody id="standings-body">
                        <tr><td colspan="7" class="p-8 text-center text-gray-600 italic">Nincs még adat. Kérlek generálj csapatokat az admin felületen.</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <div class="border-t-2 border-dashed border-gold/50 mx-10"></div>

        <section id="meccsek-section" class="fade-in scroll-mt-24">
            <h2 class="text-4xl font-bold text-gold mb-6 border-b-2 border-deep-red pb-2 flex items-center gap-3">
                <i class="fas fa-futbol red-accent"></i> Mérkőzések
            </h2>
            
            <div id="finals-container" class="mb-10">
                <h3 class="text-2xl text-deep-red font-bold mb-4 uppercase tracking-widest border-l-4 border-deep-red pl-3">Döntők</h3>
                <div class="grid md:grid-cols-2 gap-4" id="finals-list">
                    <div class="glass-panel p-4 rounded text-center text-gray-500 italic">Bronzmeccs (Nincs generálva)</div>
                    <div class="glass-panel p-4 rounded text-center text-gray-500 italic">DÖNTŐ (Nincs generálva)</div>
                </div>
            </div>

            <h3 class="text-2xl text-gray-400 font-bold mb-4 uppercase tracking-widest border-l-4 border-gray-600 pl-3">Körmérkőzések</h3>
            <div class="grid md:grid-cols-1 gap-3" id="matches-list">
                <div class="glass-panel p-4 rounded text-center text-gray-500 italic">Nincs aktív menetrend. Kérlek generálj egyet az admin felületen.</div>
            </div>
        </section>

        <div class="border-t-2 border-dashed border-gold/50 mx-10"></div>

        <section id="szabalyok-section" class="fade-in scroll-mt-24">
            <h2 class="text-4xl font-bold text-gold mb-6 border-b-2 border-deep-red pb-2 flex items-center gap-3">
                <i class="fas fa-book-open red-accent"></i> Szabályok
            </h2>
            <div class="glass-panel p-8 rounded-xl min-h-[150px]">
                <ul id="rules-list" class="space-y-4 list-disc list-inside text-lg text-gray-300">
                    </ul>
            </div>
        </section>

    </main>

    <footer class="w-full py-4 text-center relative z-40 bg-black/60 border-t border-gold/30 mt-auto">
        <div class="max-w-6xl mx-auto px-4 flex justify-between items-center text-xs text-gray-600">
            <span>&copy; 2025 Winter Cup</span>
            
            <button onclick="openAdminModal()" class="flex items-center gap-2 hover:text-gold transition-colors duration-300">
                <i class="fas fa-user-shield"></i>
                <span class="uppercase font-bold tracking-wider">Admin Belépés</span>
            </button>
        </div>
    </footer>

    <div id="admin-modal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/90 backdrop-blur-sm">
        <div class="glass-panel w-full max-w-2xl max-h-[90vh] overflow-y-auto rounded-xl p-6 m-4 relative">
            <button onclick="closeAdminModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
            
            <h2 class="text-2xl font-bold text-gold mb-6">Adminisztráció</h2>

            <div id="admin-login-view">
                <input type="password" id="admin-pass" placeholder="Jelszó" class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white mb-4 focus:border-gold outline-none">
                <button onclick="adminLogin()" class="w-full bg-gold text-black font-bold py-3 rounded hover:bg-yellow-500 transition">Belépés</button>
                <p id="login-error" class="text-red-500 mt-2 text-sm hidden">Helytelen jelszó!</p>
            </div>

            <div id="admin-dashboard-view" class="hidden space-y-8">
                
                <div class="border border-gray-700 p-4 rounded bg-black/30">
                    <h3 class="text-lg font-bold text-white mb-2">1. Csapatok Generálása</h3>
                    <textarea id="player-input" rows="4" class="w-full bg-black/50 border border-gray-600 rounded p-2 text-sm text-gray-300 mb-2" placeholder="Illeszd be a neveket (soronként 1 név)..."></textarea>
                    <button onclick="generateTournament()" class="bg-deep-red text-white px-4 py-2 rounded text-sm hover:bg-red-700 w-full">Generálás (Sorsolás + Nevek)</button>
                    <p class="text-xs text-gray-500 mt-1">Figyelem: Ez törli a jelenlegi állást!</p>
                </div>

                <div class="border border-gray-700 p-4 rounded bg-black/30">
                    <h3 class="text-lg font-bold text-white mb-2">2. Eredmények Rögzítése</h3>
                    <div id="admin-match-list" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                        </div>
                </div>

                <div class="border border-gray-700 p-4 rounded bg-black/30">
                    <h3 class="text-lg font-bold text-white mb-2">3. Szabályok Szerkesztése</h3>
                    <div class="flex gap-2">
                        <input type="text" id="new-rule-input" class="flex-1 bg-black/50 border border-gray-600 rounded p-2 text-sm" placeholder="Új szabály...">
                        <button onclick="addRule()" class="bg-gray-700 px-3 rounded hover:bg-gray-600"><i class="fas fa-plus"></i></button>
                    </div>
                    <ul id="admin-rules-list" class="mt-4 space-y-2 text-sm text-gray-400"></ul>
                </div>

                <div class="flex justify-end gap-2 pt-4 border-t border-gray-700">
                    <span id="save-status" class="text-green-400 text-sm self-center mr-2 opacity-0 transition-opacity">Mentve!</span>
                    <button onclick="forceSave()" class="bg-gold text-black px-6 py-2 rounded font-bold hover:bg-yellow-500">Adatok Mentése</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const funnyNames = [
            "Részeg Rénszarvasok", "Beigli Betyárok", "Csendes Éj Harcosai", 
            "Hólapátolók", "Reszkessetek Betörők", "Gingersbread Gengszterek",
            "Forralt Bor Kommandó", "Ajándékvadászok", "Grincs Gárdája", "Szaloncukor Zsoldosok"
        ];
        
        // Initial State
        let state = {
            teams: [],
            matches: [],
            rules: ["A pörgetés tilos (No spinning).", "Fair play mindenek felett.", "Gól után középkezdés.", "Az első 10 gólig tart a meccs."],
            generated: false
        };

        // --- FIREBASE CONFIGURATION ---
        /*
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT.firebaseio.com",
            projectId: "YOUR_PROJECT",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        */

        // Hybrid Data Sync Engine
        function loadData() {
            const local = localStorage.getItem('foosball_data');
            if (local) {
                state = JSON.parse(local);
                renderAll();
            }

            if (typeof db !== 'undefined') {
                db.ref('tournament').on('value', (snapshot) => {
                    const cloudData = snapshot.val();
                    if (cloudData) {
                        state = cloudData;
                        renderAll();
                        localStorage.setItem('foosball_data', JSON.stringify(state));
                    }
                });
            }
        }

        function saveData() {
            renderAll();
            localStorage.setItem('foosball_data', JSON.stringify(state));

            if (typeof db !== 'undefined') {
                db.ref('tournament').set(state).catch(e => console.error("Cloud sync failed", e));
            }

            const statusEl = document.getElementById('save-status');
            statusEl.style.opacity = '1';
            setTimeout(() => statusEl.style.opacity = '0', 2000);
        }

        // --- CORE LOGIC ---

        function generateTournament() {
            const rawText = document.getElementById('player-input').value.trim();
            if (!rawText) return alert("Kérlek adj meg neveket!");

            let players = rawText.split('\n').filter(n => n.trim().length > 0);
            
            // 1. Shuffle players and create teams
            for (let i = players.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [players[i], players[j]] = [players[j], players[i]];
            }

            const teams = [];
            const shuffledNames = [...funnyNames].sort(() => 0.5 - Math.random());
            
            let pIndex = 0;
            let teamId = 1;

            while (pIndex < players.length) {
                let teamName = shuffledNames[teamId - 1] || `Csapat ${teamId}`;
                let members = [];
                
                if (players.length - pIndex === 1) {
                    members = [players[pIndex], "VÁRAKOZÓ (Gép/Beugró)"];
                    pIndex++;
                } else {
                    members = [players[pIndex], players[pIndex + 1]];
                    pIndex += 2;
                }

                teams.push({
                    id: teamId,
                    name: teamName,
                    members: members,
                    stats: { played: 0, w: 0, d: 0, l: 0, pts: 0, gf: 0, ga: 0 }
                });
                teamId++;
            }

            // 2. Generate all matches and shuffle
            let matches = [];
            let matchId = 1;

            for (let i = 0; i < teams.length; i++) {
                for (let j = i + 1; j < teams.length; j++) {
                    matches.push({
                        id: matchId++,
                        t1: teams[i].id,
                        t2: teams[j].id,
                        s1: null,
                        s2: null,
                        status: 'scheduled',
                        type: 'group'
                    });
                }
            }

            matches.sort(() => 0.5 - Math.random()); // Initial shuffle

            // 3. Apply scheduling constraint (No team plays back-to-back)
            const teamIds = teams.map(t => t.id);
            const lastPlayed = teamIds.reduce((acc, id) => ({ ...acc, [id]: -2 }), {}); // -2 means they haven't played recently

            const MIN_REST = 1; // Must skip at least 1 match slot

            for (let i = 0; i < matches.length; i++) {
                const currentMatch = matches[i];
                const team1 = currentMatch.t1;
                const team2 = currentMatch.t2;

                const hasConflict = (lastPlayed[team1] >= i - MIN_REST) || (lastPlayed[team2] >= i - MIN_REST);
                
                if (hasConflict) {
                    // Try to find a safe swap: a match j > i that doesn't cause a conflict
                    let swapped = false;
                    for (let j = i + 1; j < matches.length; j++) {
                        const nextMatch = matches[j];
                        const nextT1 = nextMatch.t1;
                        const nextT2 = nextMatch.t2;

                        const nextConflictT1 = (lastPlayed[nextT1] >= i - MIN_REST) || (lastPlayed[nextT2] >= i - MIN_REST);
                        const currentConflictT2 = (lastPlayed[team1] >= j - MIN_REST) || (lastPlayed[team2] >= j - MIN_REST);
                        
                        // Check 1: Does the target match (j) fit in current slot (i)?
                        // Check 2: Does the current match (i) fit in target slot (j)?
                        if (!nextConflictT1) {
                             // Simple swap: current match (i) goes to slot j, target match (j) goes to slot i
                             [matches[i], matches[j]] = [matches[j], matches[i]];
                             swapped = true;
                             break;
                        }
                    }

                    // If no swap was possible, we have to proceed with the conflict (rare, only with very few teams)
                    if (!swapped) {
                        console.warn(`Scheduling conflict unavoidable at match ${i+1}.`);
                    }
                }
                
                // Update last played indices for the match that ACTUALLY ended up in slot i
                lastPlayed[matches[i].t1] = i;
                lastPlayed[matches[i].t2] = i;
            }


            // 4. Add Finals (fixed at the end)
            matches.push({ id: 998, t1: null, t2: null, s1: null, s2: null, status: 'scheduled', type: 'bronze', label: "Bronzmeccs" });
            matches.push({ id: 999, t1: null, t2: null, s1: null, s2: null, status: 'scheduled', type: 'gold', label: "DÖNTŐ" });

            state.teams = teams;
            state.matches = matches;
            state.generated = true;
            saveData();
            renderAdminDashboard();
        }

        function calculateStandings() {
            state.teams.forEach(t => {
                t.stats = { played: 0, w: 0, d: 0, l: 0, pts: 0, gf: 0, ga: 0 };
            });

            state.matches.filter(m => m.type === 'group' && m.status === 'played').forEach(m => {
                const t1 = state.teams.find(t => t.id === m.t1);
                const t2 = state.teams.find(t => t.id === m.t2);
                
                if(!t1 || !t2) return;

                t1.stats.gf += parseInt(m.s1); t1.stats.ga += parseInt(m.s2);
                t2.stats.gf += parseInt(m.s2); t2.stats.ga += parseInt(m.s1);
                
                t1.stats.played++;
                t2.stats.played++;

                if (m.s1 > m.s2) {
                    t1.stats.w++; t1.stats.pts += 3;
                    t2.stats.l++;
                } else if (m.s2 > m.s1) {
                    t2.stats.w++; t2.stats.pts += 3;
                    t1.stats.l++;
                } else {
                    t1.stats.d++; t1.stats.pts += 1;
                    t2.stats.d++; t2.stats.pts += 1;
                }
            });

            state.teams.sort((a, b) => {
                if (b.stats.pts !== a.stats.pts) return b.stats.pts - a.stats.pts;
                if (b.stats.w !== a.stats.w) return b.stats.w - a.stats.w;
                return (b.stats.gf - b.stats.ga) - (a.stats.gf - a.stats.ga);
            });

            if (state.teams.length >= 4) {
                const bronzeMatch = state.matches.find(m => m.type === 'bronze');
                const goldMatch = state.matches.find(m => m.type === 'gold');
                
                if (bronzeMatch && bronzeMatch.status !== 'played') {
                    bronzeMatch.t1 = state.teams[2].id;
                    bronzeMatch.t2 = state.teams[3].id;
                }
                if (goldMatch && goldMatch.status !== 'played') {
                    goldMatch.t1 = state.teams[0].id;
                    goldMatch.t2 = state.teams[1].id;
                }
            }
        }

        // --- RENDERING ---

        function renderAll() {
            calculateStandings();
            renderStandings();
            renderMatches();
            renderRules();
            renderAdminMatches();
        }

        function renderStandings() {
            const tbody = document.getElementById('standings-body');
            tbody.innerHTML = '';

            if (state.teams.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-gray-600 italic">Nincs még adat. Kérlek generálj csapatokat az admin felületen.</td></tr>';
                return;
            }
            
            state.teams.forEach((t, index) => {
                const tr = document.createElement('tr');
                // Apply a distinct background to the top three teams
                let rowClass = 'border-b border-gray-800 hover:bg-white/5 transition';
                if (index === 0) rowClass = 'bg-gold/20 border-b border-gold';
                else if (index === 1) rowClass = 'bg-gray-400/10 border-b border-gray-500';
                else if (index === 2) rowClass = 'bg-deep-red/10 border-b border-deep-red';
                
                tr.className = rowClass;
                tr.innerHTML = `
                    <td class="p-4 font-bold ${index === 0 ? 'text-gold' : 'text-gray-400'}">${index + 1}.</td>
                    <td class="p-4">
                        <div class="font-bold text-white">${t.name}</div>
                        <div class="text-xs text-gray-500">${t.members.join(' & ')}</div>
                    </td>
                    <td class="p-4 text-center text-gray-400">${t.stats.played}</td>
                    <td class="p-4 text-center text-green-400">${t.stats.w}</td>
                    <td class="p-4 text-center text-gray-400">${t.stats.d}</td>
                    <td class="p-4 text-center text-red-400">${t.stats.l}</td>
                    <td class="p-4 text-right font-bold text-gold text-xl">${t.stats.pts}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderMatches() {
            const list = document.getElementById('matches-list');
            const finalsList = document.getElementById('finals-list');
            list.innerHTML = '';
            finalsList.innerHTML = '';

            const finals = state.matches.filter(m => m.type !== 'group');
            const groups = state.matches.filter(m => m.type === 'group');

            // --- Finals ---
            if (state.teams.length >= 4 && finals.length > 0) {
                finals.sort((a, b) => (b.type === 'gold' ? 1 : -1)); // Gold first
                finals.forEach(m => {
                    const t1 = state.teams.find(t => t.id === m.t1);
                    const t2 = state.teams.find(t => t.id === m.t2);
                    
                    const borderStyle = m.type === 'gold' ? 'border-gold' : 'border-gray-500';
                    const titleColor = m.type === 'gold' ? 'text-gold' : 'text-gray-400';
                    
                    if (!t1 || !t2) {
                        finalsList.innerHTML += `<div class="glass-panel p-4 rounded text-center text-gray-500 italic border border-dashed ${borderStyle}">${m.label} (Csapatok meghatározása folyamatban)</div>`;
                        return;
                    }

                    finalsList.innerHTML += `
                        <div class="glass-panel p-4 rounded border-l-4 ${borderStyle} relative">
                            <div class="text-xs uppercase font-bold ${titleColor} mb-2">${m.label}</div>
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-white text-lg truncate">${t1.name}</span>
                                ${m.status === 'played' 
                                    ? `<span class="font-black text-deep-red text-2xl mx-3">${m.s1} - ${m.s2}</span>` 
                                    : `<span class="text-xs text-gray-500 mx-3 font-mono">VS</span>`}
                                <span class="font-bold text-white text-lg truncate">${t2.name}</span>
                            </div>
                        </div>
                    `;
                });
            } else {
                finalsList.innerHTML = `
                    <div class="glass-panel p-4 rounded text-center text-gray-500 italic">Bronzmeccs (Nincs generálva)</div>
                    <div class="glass-panel p-4 rounded text-center text-gray-500 italic">DÖNTŐ (Nincs generálva)</div>
                `;
            }

            // --- Group Stage ---
            if (groups.length === 0) {
                 list.innerHTML = `<div class="glass-panel p-4 rounded text-center text-gray-500 italic">Nincs aktív menetrend. Kérlek generálj egyet az admin felületen.</div>`;
                 return;
            }

            groups.forEach(m => {
                const t1 = state.teams.find(t => t.id === m.t1);
                const t2 = state.teams.find(t => t.id === m.t2);
                
                if (!t1 || !t2) return; 

                const statusColor = m.status === 'played' ? 'opacity-80 border-gray-700' : 'border-l-4 border-gold';

                list.innerHTML += `
                    <div class="glass-panel p-4 rounded flex justify-between items-center ${statusColor}">
                        <div class="flex-1 text-right pr-4">
                            <div class="font-bold text-gray-200">${t1.name}</div>
                        </div>
                        <div class="flex flex-col items-center min-w-[80px]">
                             ${m.status === 'played' 
                                ? `<span class="text-2xl font-black text-deep-red">${m.s1} - ${m.s2}</span>`
                                : `<span class="text-xs uppercase bg-gold/20 text-gold px-2 py-1 rounded">Tervezett</span>`
                            }
                        </div>
                        <div class="flex-1 text-left pl-4">
                            <div class="font-bold text-gray-200">${t2.name}</div>
                        </div>
                    </div>
                `;
            });
        }

        function renderRules() {
            const list = document.getElementById('rules-list');
            list.innerHTML = state.rules.map(r => `<li>${r}</li>`).join('');
            
            const adminList = document.getElementById('admin-rules-list');
            adminList.innerHTML = state.rules.map((r, i) => `
                <li class="flex justify-between items-center bg-black/40 p-2 rounded">
                    <span>${r}</span>
                    <button onclick="deleteRule(${i})" class="text-red-500 hover:text-red-400"><i class="fas fa-trash"></i></button>
                </li>
            `).join('');
        }

        function renderAdminMatches() {
            const list = document.getElementById('admin-match-list');
            list.innerHTML = '';
            
            state.matches.forEach(m => {
                const t1 = state.teams.find(t => t.id === m.t1);
                const t2 = state.teams.find(t => t.id === m.t2);
                if (!t1 || !t2) return;

                const div = document.createElement('div');
                div.className = "flex items-center gap-2 bg-black/40 p-2 rounded text-sm";
                div.innerHTML = `
                    <span class="w-8 text-xs text-gray-500">#${m.id}</span>
                    <span class="flex-1 text-right truncate text-gray-300">${t1.name}</span>
                    <input type="number" onchange="updateScore(${m.id}, 's1', this.value)" value="${m.s1 ?? ''}" class="w-10 bg-gray-800 border border-gray-600 rounded text-center text-white" placeholder="0">
                    <span class="text-gray-500">-</span>
                    <input type="number" onchange="updateScore(${m.id}, 's2', this.value)" value="${m.s2 ?? ''}" class="w-10 bg-gray-800 border border-gray-600 rounded text-center text-white" placeholder="0">
                    <span class="flex-1 text-left truncate text-gray-300">${t2.name}</span>
                `;
                list.appendChild(div);
            });
        }

        // --- INTERACTION ---

        function updateScore(matchId, field, value) {
            const match = state.matches.find(m => m.id === matchId);
            if (match) {
                // Ensure value is treated as number and handle empty string gracefully
                const score = value === "" ? null : parseInt(value);
                match[field] = score;
                
                if (match.s1 !== null && match.s2 !== null) {
                    match.status = 'played';
                } else {
                    match.status = 'scheduled';
                }
            }
        }

        function forceSave() {
            saveData();
        }

        function addRule() {
            const input = document.getElementById('new-rule-input');
            if (input.value.trim()) {
                state.rules.push(input.value.trim());
                input.value = '';
                saveData();
            }
        }

        function deleteRule(index) {
            state.rules.splice(index, 1);
            saveData();
        }

        // Admin Auth
        function openAdminModal() {
            document.getElementById('admin-modal').classList.remove('hidden');
            document.getElementById('admin-modal').classList.add('flex');
        }
        function closeAdminModal() {
            document.getElementById('admin-modal').classList.add('hidden');
            document.getElementById('admin-modal').classList.remove('flex');
        }
        function adminLogin() {
            const pass = document.getElementById('admin-pass').value;
            if (pass === 'Jimmy92') {
                document.getElementById('admin-login-view').classList.add('hidden');
                document.getElementById('admin-dashboard-view').classList.remove('hidden');
                renderAdminDashboard();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        }

        function renderAdminDashboard() {
            renderAdminMatches();
            renderRules();
        }

        // --- THREE.JS BACKGROUND ---
        
        function initThreeJS() {
            const container = document.getElementById('threejs-display'); // Attaching to the main display area
            const scene = new THREE.Scene();
            
            // Camera (moved back slightly to better frame the object)
            const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.z = 15;
            camera.position.y = 8; // Slightly lower angle
            camera.lookAt(0, 0, 0);

            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.domElement.style.position = 'absolute';
            renderer.domElement.style.top = '0';
            renderer.domElement.style.left = '0';
            container.appendChild(renderer.domElement);

            // Lighting (Gold and Red accents)
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);
            const goldLight = new THREE.PointLight(0xd4af37, 1.5, 100);
            goldLight.position.set(10, 10, 10);
            scene.add(goldLight);
            const redLight = new THREE.PointLight(0x8B0000, 1.0, 100);
            redLight.position.set(-10, 5, -5);
            scene.add(redLight);

            // Foosball Field (Abstract)
            const fieldGroup = new THREE.Group();
            
            // Green Pitch
            const geometry = new THREE.BoxGeometry(16, 0.5, 10);
            const material = new THREE.MeshStandardMaterial({ color: 0x0f3b1e, roughness: 0.3, metalness: 0.1 });
            const field = new THREE.Mesh(geometry, material);
            fieldGroup.add(field);

            // Lines (White Planes)
            const lineMat = new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.6 });
            const centerLine = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.51, 10), lineMat);
            fieldGroup.add(centerLine);

            // Goals - Highlighted with Red/Deep Red
            const goalMat = new THREE.MeshBasicMaterial({ color: 0x8B0000 });
            const goal1 = new THREE.Mesh(new THREE.BoxGeometry(1, 0.51, 4), goalMat);
            goal1.position.x = -8;
            fieldGroup.add(goal1);
            
            const goal2 = new THREE.Mesh(new THREE.BoxGeometry(1, 0.51, 4), goalMat);
            goal2.position.x = 8;
            fieldGroup.add(goal2);

            fieldGroup.rotation.y = 0.5;
            scene.add(fieldGroup);

            // Snow Particles (Attached to fixed background canvas, not the floating field)
            const backgroundCanvas = document.getElementById('canvas-container'); // Need a separate canvas for the snow
            const snowScene = new THREE.Scene();
            const snowRenderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            snowRenderer.setSize(window.innerWidth, window.innerHeight);
            snowRenderer.domElement.style.position = 'absolute';
            snowRenderer.domElement.style.top = '0';
            snowRenderer.domElement.style.left = '0';
            backgroundCanvas.appendChild(snowRenderer.domElement);

            const particlesGeometry = new THREE.BufferGeometry();
            const particlesCount = 2000; // More snow
            const posArray = new Float32Array(particlesCount * 3);

            for(let i = 0; i < particlesCount * 3; i++) {
                posArray[i] = (Math.random() - 0.5) * 100; // Wider spread
            }

            particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            const particlesMaterial = new THREE.PointsMaterial({
                size: 0.2,
                color: 0xffffff,
                transparent: true,
                opacity: 0.7
            });
            const snowMesh = new THREE.Points(particlesGeometry, particlesMaterial);
            snowScene.add(snowMesh);

            // Mouse Interaction (Affecting the field camera)
            let mouseX = 0;
            let mouseY = 0;
            document.addEventListener('mousemove', (event) => {
                mouseX = (event.clientX / window.innerWidth) - 0.5;
                mouseY = (event.clientY / window.innerHeight) - 0.5;
            });

            // Animation Loop
            function animate() {
                requestAnimationFrame(animate);

                // Field Animation
                fieldGroup.rotation.y += 0.002;
                fieldGroup.rotation.x = Math.sin(Date.now() * 0.0001) * 0.1;

                // Field Camera Reaction
                camera.position.x += (mouseX * 5 - camera.position.x) * 0.05;
                camera.position.y += (-mouseY * 3 + 8 - camera.position.y) * 0.05;
                camera.lookAt(0, 0, 0);
                renderer.render(scene, camera);


                // Snow Animation
                const positions = snowMesh.geometry.attributes.position.array;
                for(let i = 1; i < particlesCount * 3; i+=3) {
                    positions[i] -= 0.05; // slower, gentle fall
                    if (positions[i] < -50) { // reset from above
                        positions[i] = 50;
                    }
                }
                snowMesh.geometry.attributes.position.needsUpdate = true;
                snowRenderer.render(snowScene, camera);
            }
            animate();

            // Resize Handle
            window.addEventListener('resize', () => {
                // Field Renderer Resize
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);

                // Snow Renderer Resize
                snowRenderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        window.onload = function() {
            initThreeJS();
            loadData();
        };

    </script>
</body>
</html>
